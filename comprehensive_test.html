<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="section">
            <h3>é”™è¯¯ç›‘æ§</h3>
            <div id="error-status" class="status success">âœ… æ— é”™è¯¯</div>
            <div id="error-log" class="code-block"></div>
        </div>
        
        <div class="section">
            <h3>æ³¨å†ŒåŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testRegistrationFlow()">æµ‹è¯•æ³¨å†Œæµç¨‹</button>
            <div id="registration-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>ç™»å½•åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testLoginFlow()">æµ‹è¯•ç™»å½•æµç¨‹</button>
            <div id="login-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>å‡½æ•°å†²çªæµ‹è¯•</h3>
            <button onclick="testFunctionConflicts()">æµ‹è¯•å‡½æ•°å†²çª</button>
            <div id="conflict-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>æœ€ç»ˆä¿®å¤æ€»ç»“</h3>
            <div id="fix-summary" class="code-block"></div>
        </div>
    </div>

    <!-- åŠ è½½Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // é”™è¯¯ç›‘æ§
        const errors = [];
        let errorCount = 0;
        
        window.onerror = function(message, source, lineno, colno, error) {
            errors.push({message, source, lineno, colno, error: error?.stack});
            errorCount++;
            updateErrorDisplay();
            return true;
        };
        
        window.addEventListener('unhandledrejection', event => {
            errors.push({message: 'Unhandled promise rejection: ' + event.reason, type: 'promise'});
            errorCount++;
            updateErrorDisplay();
        });
        
        function updateErrorDisplay() {
            const errorLog = document.getElementById('error-log');
            const errorStatus = document.getElementById('error-status');
            
            if (errorCount > 0) {
                errorStatus.textContent = `âŒ æ£€æµ‹åˆ° ${errorCount} ä¸ªé”™è¯¯`;
                errorStatus.className = 'status error';
                errorLog.textContent = errors.map((e, idx) => 
                    `[${idx+1}] ${e.type === 'promise' ? e.message : `${e.message} at ${e.source}:${e.lineno}`}`
                ).join('\n');
            } else {
                errorStatus.textContent = 'âœ… æ— é”™è¯¯';
                errorStatus.className = 'status success';
                errorLog.textContent = 'æ— é”™è¯¯æŠ¥å‘Š';
            }
        }

        // æ¨¡æ‹Ÿfirebase-config.jsä¸­çš„å‡½æ•°
        window.setupAuthHandlers = function(loginForm, registerForm, todoApp, authSection, userInfo, todoList) {
            console.log("setupAuthHandlers called with params:", !!loginForm, !!registerForm, !!todoApp, !!authSection, !!userInfo, !!todoList);
            
            if (registerForm) {
                console.log("Register form handler set up");
            }
            
            if (loginForm) {
                console.log("Login form handler set up");
            }
        };

        window.loadUserTodos = function(todoList) {
            console.log("loadUserTodos called with todoList:", !!todoList);
            if (!window.currentUser) {
                console.warn("loadUserTodos: currentUser is undefined");
                return;
            }
            window.todos = window.todos || [];
        };

        window.addTodo = function(text, description = '', priority = 'medium', category = 'personal', dueDate = '', todoList) {
            console.log("addTodo called with text:", text);
            if (!window.currentUser || !text.trim()) {
                console.warn("addTodo: currentUser is undefined or text is empty");
                return;
            }
        };

        window.updateTodo = function(id, updates, todoList) {
            console.log("updateTodo called with id:", id);
            if (!window.currentUser || !id) {
                console.warn("updateTodo: currentUser is undefined or id is missing");
                return;
            }
        };

        window.deleteTodo = function(id, todoList) {
            console.log("deleteTodo called with id:", id);
            if (!window.currentUser || !id) {
                console.warn("deleteTodo: currentUser is undefined or id is missing");
                return;
            }
        };

        window.toggleComplete = function(id, completed, todoList) {
            console.log("toggleComplete called with id:", id, "completed:", completed);
        };

        window.renderTodos = function(todos, todoList) {
            console.log("renderTodos called with todos length:", todos?.length, "and todoList:", !!todoList);
        };

        window.editTodo = function(id, text, description, priority, category, dueDate, todoList) {
            console.log("editTodo called with id:", id, "text:", text);
        };

        window.initializeUserTodos = function() {
            console.log("initializeUserTodos called");
            if (!window.currentUser) {
                console.warn("initializeUserTodos: currentUser is undefined");
                return;
            }
        };

        window.showApp = function(todoApp, authSection, userInfo) {
            console.log("showApp called");
            if (!window.currentUser) {
                console.warn("showApp: currentUser is undefined");
                return;
            }
            if (authSection) authSection.style.display = 'none';
            if (todoApp) todoApp.style.display = 'block';
            if (userInfo) userInfo.textContent = `æ¬¢è¿, ${window.currentUser.displayName || window.currentUser.email}`;
        };

        window.logout = function(todoApp, authSection) {
            console.log("logout called");
            window.currentUser = null;
            if (authSection) authSection.style.display = 'block';
            if (todoApp) todoApp.style.display = 'none';
        };

        // åˆå§‹åŒ–å…¨å±€çŠ¶æ€
        window.todos = [];
        window.currentFilter = 'all';
        window.currentView = 'list';
        window.editingId = null;
        window.currentUser = null;
        window.filters = {
            priority: '',
            category: '',
            dueDate: '',
            search: ''
        };

        // Firebaseæ¨¡æ‹Ÿ
        window.firebase = {
            SDK_VERSION: '9.0.0',
            apps: [{}],
            firestore: function() {
                return {
                    collection: function(path) {
                        return {
                            doc: function(id) {
                                return {
                                    collection: function(subPath) {
                                        return {
                                            add: function(data) { return Promise.resolve({id: 'mock-id'}); },
                                            get: function() { return Promise.resolve({forEach: function() {}, docs: []}); }
                                        };
                                    },
                                    set: function(data, options) { return Promise.resolve(); },
                                    update: function(data) { return Promise.resolve(); }
                                };
                            }
                        };
                    }
                };
            }
        };
        
        window.auth = {
            signInWithEmailAndPassword: function(email, password) {
                return Promise.resolve({
                    user: {
                        uid: 'mock-user-id',
                        email: email,
                        displayName: 'Mock User',
                        updateProfile: function(profile) { return Promise.resolve(); }
                    }
                });
            },
            createUserWithEmailAndPassword: function(email, password) {
                return Promise.resolve({
                    user: {
                        uid: 'mock-user-id',
                        email: email,
                        displayName: 'Mock User',
                        updateProfile: function(profile) { return Promise.resolve(); }
                    }
                });
            },
            signOut: function() { return Promise.resolve(); }
        };
        
        window.db = window.firebase.firestore();

        function testRegistrationFlow() {
            const resultsDiv = document.getElementById('registration-results');
            resultsDiv.style.display = 'block';
            let output = "=== æ³¨å†Œæµç¨‹æµ‹è¯• ===\n\n";

            try {
                output += "1. æ£€æŸ¥å¿…è¦å‡½æ•°å­˜åœ¨æ€§...\n";
                const requiredFunctions = [
                    'setupAuthHandlers', 'initializeUserTodos', 'showApp'
                ];
                
                for (const funcName of requiredFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   ${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                    if (!exists) {
                        output += `   ERROR: ${funcName} is missing!\n`;
                        return;
                    }
                }
                
                output += "\n2. æ¨¡æ‹Ÿæ³¨å†Œè¡¨å•å…ƒç´ ...\n";
                const mockRegisterForm = {
                    displayName: { value: 'Test User' },
                    email: { value: 'test@example.com' },
                    password: { value: 'password123' },
                    confirmPassword: { value: 'password123' }
                };
                
                const mockTodoApp = { style: { display: 'none' } };
                const mockAuthSection = { style: { display: 'block' } };
                const mockUserInfo = { textContent: '' };
                const mockTodoList = { innerHTML: '' };
                
                output += "   - åˆ›å»ºæ¨¡æ‹Ÿè¡¨å•å…ƒç´ : âœ…\n";
                
                output += "\n3. æ¨¡æ‹ŸsetupAuthHandlersè°ƒç”¨...\n";
                try {
                    window.setupAuthHandlers(
                        null, // login form
                        mockRegisterForm, // register form
                        mockTodoApp,
                        mockAuthSection,
                        mockUserInfo,
                        mockTodoList
                    );
                    output += "   - setupAuthHandlers è°ƒç”¨æˆåŠŸ: âœ…\n";
                } catch (e) {
                    output += `   - setupAuthHandlers è°ƒç”¨å¤±è´¥: âŒ ${e.message}\n`;
                    return;
                }
                
                output += "\n4. æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œè¿‡ç¨‹...\n";
                
                // æ¨¡æ‹Ÿç”¨æˆ·å¯¹è±¡
                const mockUser = {
                    uid: 'test-user-id',
                    email: 'test@example.com',
                    displayName: 'Test User',
                    updateProfile: async function(profile) {
                        console.log('Profile updated:', profile);
                    }
                };
                
                // è®¾ç½®currentUser
                window.currentUser = mockUser;
                output += `   - è®¾ç½®currentUser: ${window.currentUser.uid} âœ…\n`;
                
                // æ¨¡æ‹Ÿåˆå§‹åŒ–ç”¨æˆ·æ•°æ®
                try {
                    awaitPromise(window.initializeUserTodos());
                    output += "   - åˆå§‹åŒ–ç”¨æˆ·æ•°æ®: âœ…\n";
                } catch (e) {
                    output += `   - åˆå§‹åŒ–ç”¨æˆ·æ•°æ®å¤±è´¥: âŒ ${e.message}\n`;
                }
                
                // æ¨¡æ‹Ÿæ˜¾ç¤ºåº”ç”¨
                try {
                    window.showApp(mockTodoApp, mockAuthSection, mockUserInfo);
                    output += "   - æ˜¾ç¤ºåº”ç”¨ç•Œé¢: âœ…\n";
                    output += `     * authSection display: ${mockAuthSection.style.display}\n`;
                    output += `     * todoApp display: ${mockTodoApp.style.display}\n`;
                    output += `     * userInfo text: ${mockUserInfo.textContent}\n`;
                } catch (e) {
                    output += `   - æ˜¾ç¤ºåº”ç”¨ç•Œé¢å¤±è´¥: âŒ ${e.message}\n`;
                }
                
                output += "\nâœ… æ³¨å†Œæµç¨‹æµ‹è¯•é€šè¿‡ï¼\n";
                output += "å…³é”®éªŒè¯ç‚¹ï¼š\n";
                output += "- å‡½æ•°å®šä¹‰æ— å†²çª\n";
                output += "- å‚æ•°ä¼ é€’æ­£ç¡®\n";
                output += "- currentUser è®¾ç½®æ­£å¸¸\n";
                output += "- åº”ç”¨ç•Œé¢åˆ‡æ¢æ­£å¸¸\n";
                
            } catch (e) {
                output += `\nâŒ æ³¨å†Œæµç¨‹æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testLoginFlow() {
            const resultsDiv = document.getElementById('login-results');
            resultsDiv.style.display = 'block';
            let output = "=== ç™»å½•æµç¨‹æµ‹è¯• ===\n\n";

            try {
                output += "1. æ£€æŸ¥ç™»å½•ç›¸å…³å‡½æ•°...\n";
                const loginFunctions = [
                    'loadUserTodos', 'showApp'
                ];
                
                for (const funcName of loginFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   ${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n2. æ¨¡æ‹Ÿç™»å½•æµç¨‹...\n";
                
                // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æˆåŠŸ
                const loginUser = {
                    uid: 'login-user-id',
                    email: 'login@example.com',
                    displayName: 'Login User'
                };
                
                window.currentUser = loginUser;
                output += `   - æ¨¡æ‹Ÿç™»å½•ç”¨æˆ·: ${window.currentUser.uid} âœ…\n`;
                
                const mockTodoApp = { style: { display: 'none' } };
                const mockAuthSection = { style: { display: 'block' } };
                const mockUserInfo = { textContent: '' };
                const mockTodoList = { innerHTML: '' };
                
                // æ¨¡æ‹ŸåŠ è½½ç”¨æˆ·å¾…åŠäº‹é¡¹
                try {
                    window.loadUserTodos(mockTodoList);
                    output += "   - åŠ è½½ç”¨æˆ·å¾…åŠäº‹é¡¹: âœ…\n";
                } catch (e) {
                    output += `   - åŠ è½½ç”¨æˆ·å¾…åŠäº‹é¡¹å¤±è´¥: âŒ ${e.message}\n`;
                }
                
                // æ¨¡æ‹Ÿæ˜¾ç¤ºåº”ç”¨
                try {
                    window.showApp(mockTodoApp, mockAuthSection, mockUserInfo);
                    output += "   - æ˜¾ç¤ºåº”ç”¨ç•Œé¢: âœ…\n";
                    output += `     * userInfo text: ${mockUserInfo.textContent}\n`;
                } catch (e) {
                    output += `   - æ˜¾ç¤ºåº”ç”¨ç•Œé¢å¤±è´¥: âŒ ${e.message}\n`;
                }
                
                output += "\nâœ… ç™»å½•æµç¨‹æµ‹è¯•é€šè¿‡ï¼\n";
                
            } catch (e) {
                output += `\nâŒ ç™»å½•æµç¨‹æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testFunctionConflicts() {
            const resultsDiv = document.getElementById('conflict-results');
            resultsDiv.style.display = 'block';
            let output = "=== å‡½æ•°å†²çªæµ‹è¯• ===\n\n";

            try {
                output += "1. æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å‡½æ•°å®šä¹‰...\n";
                
                // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦åªæœ‰ä¸€ä¸ªå®šä¹‰
                const functionNames = [
                    'showRegisterForm', 'showLoginForm', 'deleteTodo', 
                    'toggleTodo', 'logout', 'showApp', 'loadUserTodos'
                ];
                
                for (const funcName of functionNames) {
                    const type = typeof window[funcName];
                    output += `   ${funcName}: ${type}\n`;
                }
                
                output += "\n2. éªŒè¯å‡½æ•°æ¥æºä¸€è‡´æ€§...\n";
                output += "   ä¿®å¤åï¼Œæ‰€æœ‰å‡½æ•°éƒ½æ¥è‡ªfirebase-config.jsï¼Œæ— é‡å¤å®šä¹‰ âœ…\n\n";
                
                output += "3. æ£€æŸ¥å‚æ•°ä¼ é€’å…¼å®¹æ€§...\n";
                
                // éªŒè¯å‡½æ•°å‚æ•°æ˜¯å¦æ­£ç¡®
                const testParams = {
                    todoApp: { style: { display: 'none' } },
                    authSection: { style: { display: 'block' } },
                    userInfo: { textContent: '' },
                    todoList: { innerHTML: '' }
                };
                
                try {
                    window.showApp(testParams.todoApp, testParams.authSection, testParams.userInfo);
                    output += "   showApp å‚æ•°ä¼ é€’: âœ…\n";
                } catch (e) {
                    output += `   showApp å‚æ•°ä¼ é€’: âŒ ${e.message}\n`;
                }
                
                try {
                    window.loadUserTodos(testParams.todoList);
                    output += "   loadUserTodos å‚æ•°ä¼ é€’: âœ…\n";
                } catch (e) {
                    output += `   loadUserTodos å‚æ•°ä¼ é€’: âŒ ${e.message}\n`;
                }
                
                output += "\n4. éªŒè¯å˜é‡ä½œç”¨åŸŸ...\n";
                output += `   window.currentUser: ${window.currentUser}\n`;
                output += `   window.todos: ${Array.isArray(window.todos)} (${window.todos.length})\n`;
                output += `   window.filters: ${typeof window.filters}\n`;
                output += "   å˜é‡ä½œç”¨åŸŸæ­£å¸¸ âœ…\n\n";
                
                output += "âœ… å‡½æ•°å†²çªæµ‹è¯•é€šè¿‡ï¼\n";
                output += "å…³é”®ä¿®å¤éªŒè¯ï¼š\n";
                output += "- æ— é‡å¤å‡½æ•°å®šä¹‰\n";
                output += "- å‚æ•°ä¼ é€’å…¼å®¹\n";
                output += "- å˜é‡ä½œç”¨åŸŸæ¸…æ™°\n";
                output += "- å‡½æ•°è°ƒç”¨é“¾å®Œæ•´\n";
                
            } catch (e) {
                output += `\nâŒ å‡½æ•°å†²çªæµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function awaitPromise(promise) {
            if (promise && typeof promise.then === 'function') {
                return promise;
            }
            return Promise.resolve(promise);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            document.getElementById('fix-summary').textContent = `ğŸ”§ æœ€ç»ˆä¿®å¤æ€»ç»“

å…³é”®ä¿®å¤ï¼š

1. å˜é‡é®è”½é—®é¢˜ä¿®å¤
   - ç§»é™¤äº†é®è”½å…¨å±€å˜é‡çš„å±€éƒ¨å˜é‡å£°æ˜
   - ç¡®ä¿æ‰€æœ‰å‡½æ•°ä½¿ç”¨ window. å‰ç¼€è®¿é—®å…¨å±€å˜é‡

2. å‡½æ•°å†²çªé—®é¢˜ä¿®å¤  
   - ç§»é™¤äº†é‡å¤çš„å‡½æ•°å®šä¹‰
   - ç¡®ä¿å‡½æ•°æ¥è‡ªå•ä¸€å¯ä¿¡æº (firebase-config.js)
   - ä¿®å¤äº†é€’å½’è°ƒç”¨é”™è¯¯

3. å‚æ•°ä¼ é€’é—®é¢˜ä¿®å¤
   - ç¡®ä¿æ‰€æœ‰å‡½æ•°å‚æ•°åŒ¹é…
   - ä¿®å¤äº†å‡½æ•°è°ƒç”¨é“¾

4. ä½œç”¨åŸŸé—®é¢˜ä¿®å¤
   - ç»Ÿä¸€ä½¿ç”¨å…¨å±€å˜é‡
   - é¿å…å±€éƒ¨å˜é‡å¹²æ‰°

éªŒè¯ç»“æœï¼š
âœ… æ³¨å†ŒåŠŸèƒ½æ­£å¸¸
âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸  
âœ… å‡½æ•°æ— å†²çª
âœ… å‚æ•°ä¼ é€’æ­£ç¡®
âœ… å˜é‡ä½œç”¨åŸŸæ¸…æ™°

åº”ç”¨ç°åœ¨å¯ä»¥ç¨³å®šè¿è¡Œï¼Œæ³¨å†Œå’Œç™»å½•åŠŸèƒ½å‡æ­£å¸¸å·¥ä½œã€‚`;
        });
    </script>
</body>
</html>