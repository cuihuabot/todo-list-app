<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶æ„æµ‹è¯• - æ•°æ®å±‚ä¸UIå±‚åˆ†ç¦»</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ¶æ„æµ‹è¯• - æ•°æ®å±‚ä¸UIå±‚åˆ†ç¦»</h1>
        
        <div class="section">
            <h3>é”™è¯¯ç›‘æ§</h3>
            <div id="error-status" class="status success">âœ… æ— é”™è¯¯</div>
            <div id="error-log" class="code-block"></div>
        </div>
        
        <div class="section">
            <h3>æ–°æ¶æ„éªŒè¯</h3>
            <button onclick="testArchitecture()">æµ‹è¯•æ–°æ¶æ„</button>
            <div id="architecture-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>æ•°æ®å±‚æµ‹è¯•</h3>
            <button onclick="testDataLayer()">æµ‹è¯•æ•°æ®å±‚</button>
            <div id="data-layer-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>UIå±‚æµ‹è¯•</h3>
            <button onclick="testUILayer()">æµ‹è¯•UIå±‚</button>
            <div id="ui-layer-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>æœ€ç»ˆéªŒè¯</h3>
            <button onclick="finalValidation()">æœ€ç»ˆéªŒè¯</button>
            <div id="final-results" class="code-block" style="display:none;"></div>
        </div>
    </div>

    <script>
        // é”™è¯¯ç›‘æ§
        const errors = [];
        let errorCount = 0;
        
        window.onerror = function(message, source, lineno, colno, error) {
            errors.push({message, source, lineno, colno, error: error?.stack});
            errorCount++;
            updateErrorDisplay();
            return true;
        };
        
        window.addEventListener('unhandledrejection', event => {
            errors.push({message: 'Unhandled promise rejection: ' + event.reason, type: 'promise'});
            errorCount++;
            updateErrorDisplay();
        });
        
        function updateErrorDisplay() {
            const errorLog = document.getElementById('error-log');
            const errorStatus = document.getElementById('error-status');
            
            if (errorCount > 0) {
                errorStatus.textContent = `âŒ æ£€æµ‹åˆ° ${errorCount} ä¸ªé”™è¯¯`;
                errorStatus.className = 'status error';
                errorLog.textContent = errors.map((e, idx) => 
                    `[${idx+1}] ${e.type === 'promise' ? e.message : `${e.message} at ${e.source}:${e.lineno}`}`
                ).join('\n');
            } else {
                errorStatus.textContent = 'âœ… æ— é”™è¯¯';
                errorStatus.className = 'status success';
                errorLog.textContent = 'æ— é”™è¯¯æŠ¥å‘Š';
            }
        }

        function testArchitecture() {
            const resultsDiv = document.getElementById('architecture-results');
            resultsDiv.style.display = 'block';
            let output = "=== æ–°æ¶æ„éªŒè¯ ===\n\n";

            try {
                output += "1. æ£€æŸ¥åˆ†å±‚æ¶æ„...\n";
                
                // æ¨¡æ‹Ÿæ–°æ¶æ„
                output += "   æ•°æ®å±‚èŒè´£ï¼š\n";
                output += "   - å¤„ç†Firebaseäº¤äº’\n";
                output += "   - æä¾›çº¯æ•°æ®æ“ä½œå‡½æ•°\n";
                output += "   - é€šè¿‡å›è°ƒé€šçŸ¥UIå±‚\n\n";
                
                output += "   UIå±‚èŒè´£ï¼š\n";
                output += "   - å¤„ç†DOMæ“ä½œ\n";
                + "   - å®ç°å¤æ‚æ¸²æŸ“é€»è¾‘\n";
                output += "   - å“åº”ç”¨æˆ·äº¤äº’\n\n";
                
                output += "2. éªŒè¯å‡½æ•°åˆ†ç¦»...\n";
                
                // æ£€æŸ¥æ•°æ®å±‚å‡½æ•°
                const dataLayerFunctions = [
                    'loadUserTodosData',
                    'addTodoData', 
                    'updateTodoData',
                    'deleteTodoData',
                    'initializeUserTodos'
                ];
                
                for (const funcName of dataLayerFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   æ•°æ®å±‚.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n";
                
                // æ£€æŸ¥UIå±‚å‡½æ•°
                const uiLayerFunctions = [
                    'loadUserTodos',
                    'addTodo',
                    'updateTodo', 
                    'deleteTodo',
                    'renderTodos'
                ];
                
                for (const funcName of uiLayerFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   UIå±‚.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n3. éªŒè¯å›è°ƒæœºåˆ¶...\n";
                
                const callbackFunctions = [
                    'onUserLoggedIn',
                    'onUserLoggedOut', 
                    'onTodosChanged'
                ];
                
                for (const funcName of callbackFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   å›è°ƒ.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\nâœ… æ–°æ¶æ„éªŒè¯é€šè¿‡ï¼\n";
                output += "å…³é”®æ”¹è¿›ï¼š\n";
                output += "- æ•°æ®å±‚ä¸UIå±‚å®Œå…¨åˆ†ç¦»\n";
                output += "- æ¶ˆé™¤å‡½æ•°å†²çª\n";
                output += "- æ˜ç¡®èŒè´£åˆ†å·¥\n";
                output += "- é€šè¿‡å›è°ƒé€šä¿¡\n";
                
            } catch (e) {
                output += `\nâŒ æ¶æ„éªŒè¯å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testDataLayer() {
            const resultsDiv = document.getElementById('data-layer-results');
            resultsDiv.style.display = 'block';
            let output = "=== æ•°æ®å±‚æµ‹è¯• ===\n\n";

            try {
                output += "1. æ¨¡æ‹Ÿæ•°æ®å±‚å‡½æ•°...\n";
                
                // æ¨¡æ‹Ÿæ•°æ®å±‚å‡½æ•°
                window.loadUserTodosData = async function() {
                    console.log("loadUserTodosData called");
                    if (!window.currentUser) {
                        console.warn("loadUserTodosData: currentUser is undefined");
                        return [];
                    }
                    return [
                        { id: '1', text: 'æ¨¡æ‹Ÿä»»åŠ¡1', completed: false, priority: 'medium' },
                        { id: '2', text: 'æ¨¡æ‹Ÿä»»åŠ¡2', completed: true, priority: 'high' }
                    ];
                };

                window.addTodoData = async function(text, description, priority, category, dueDate) {
                    console.log("addTodoData called with:", text);
                    if (typeof window.onTodosChanged === 'function') {
                        window.onTodosChanged();
                    }
                };

                window.updateTodoData = async function(id, updates) {
                    console.log("updateTodoData called with:", id, updates);
                    if (typeof window.onTodosChanged === 'function') {
                        window.onTodosChanged();
                    }
                };

                window.deleteTodoData = async function(id) {
                    console.log("deleteTodoData called with:", id);
                    if (typeof window.onTodosChanged === 'function') {
                        window.onTodosChanged();
                    }
                };

                output += "   - loadUserTodosData: å·²å®šä¹‰ âœ…\n";
                output += "   - addTodoData: å·²å®šä¹‰ âœ…\n";
                output += "   - updateTodoData: å·²å®šä¹‰ âœ…\n";
                output += "   - deleteTodoData: å·²å®šä¹‰ âœ…\n\n";

                output += "2. æµ‹è¯•æ•°æ®å±‚å‡½æ•°è°ƒç”¨...\n";
                
                // æ¨¡æ‹Ÿç”¨æˆ·
                window.currentUser = { uid: 'test-user', email: 'test@example.com', displayName: 'Test User' };
                
                // æµ‹è¯•åŠ è½½æ•°æ®
                const todos = await window.loadUserTodosData();
                output += `   - åŠ è½½å¾…åŠäº‹é¡¹: ${todos.length} é¡¹ âœ…\n`;
                
                // æµ‹è¯•æ·»åŠ æ•°æ®
                await window.addTodoData("æµ‹è¯•ä»»åŠ¡", "", "medium", "personal", "");
                output += "   - æ·»åŠ å¾…åŠäº‹é¡¹: æˆåŠŸ âœ…\n";
                
                // æµ‹è¯•æ›´æ–°æ•°æ®
                await window.updateTodoData("1", { completed: true });
                output += "   - æ›´æ–°å¾…åŠäº‹é¡¹: æˆåŠŸ âœ…\n";
                
                // æµ‹è¯•åˆ é™¤æ•°æ®
                await window.deleteTodoData("2");
                output += "   - åˆ é™¤å¾…åŠäº‹é¡¹: æˆåŠŸ âœ…\n\n";
                
                output += "3. éªŒè¯å›è°ƒè§¦å‘...\n";
                output += "   - æ¯ä¸ªæ•°æ®æ“ä½œéƒ½ä¼šè§¦å‘ onTodosChanged å›è°ƒ âœ…\n\n";
                
                output += "âœ… æ•°æ®å±‚æµ‹è¯•é€šè¿‡ï¼\n";
                output += "ç‰¹ç‚¹ï¼šçº¯æ•°æ®æ“ä½œï¼Œæ— UIä¾èµ–\n";
                
            } catch (e) {
                output += `\nâŒ æ•°æ®å±‚æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testUILayer() {
            const resultsDiv = document.getElementById('ui-layer-results');
            resultsDiv.style.display = 'block';
            let output = "=== UIå±‚æµ‹è¯• ===\n\n";

            try {
                output += "1. æ¨¡æ‹ŸUIå±‚å‡½æ•°...\n";
                
                // æ¨¡æ‹ŸUIå±‚å‡½æ•°
                window.todos = [];
                window.currentFilter = 'all';
                window.filters = { priority: '', category: '', dueDate: '', search: '' };
                
                window.renderTodos = function() {
                    console.log("renderTodos called with filter:", window.currentFilter);
                    if (!window.todoList) {
                        window.todoList = { innerHTML: '' };
                    }
                    
                    let filteredTodos = [...window.todos];
                    
                    // åº”ç”¨è¿‡æ»¤å™¨
                    filteredTodos = filteredTodos.filter(todo => {
                        if (window.currentFilter === 'active') return !todo.completed;
                        if (window.currentFilter === 'completed') return todo.completed;
                        return true;
                    });
                    
                    window.todoList.innerHTML = `<div>æ¸²æŸ“äº† ${filteredTodos.length} ä¸ªå¾…åŠäº‹é¡¹</div>`;
                };

                window.loadUserTodos = async function() {
                    console.log("loadUserTodos called");
                    if (typeof window.loadUserTodosData === 'function') {
                        window.todos = await window.loadUserTodosData();
                        window.renderTodos();
                        if (typeof window.updateStats === 'function') {
                            window.updateStats();
                        }
                    }
                };

                window.addTodo = async function(text, description, priority, category, dueDate) {
                    console.log("addTodo called with:", text);
                    if (typeof window.addTodoData === 'function') {
                        try {
                            await window.addTodoData(text, description, priority, category, dueDate);
                        } catch (e) {
                            console.error("Error in addTodo:", e);
                        }
                    }
                };

                window.updateTodo = async function(id, updates) {
                    console.log("updateTodo called with:", id);
                    if (typeof window.updateTodoData === 'function') {
                        try {
                            await window.updateTodoData(id, updates);
                        } catch (e) {
                            console.error("Error in updateTodo:", e);
                        }
                    }
                };

                window.deleteTodo = async function(id) {
                    console.log("deleteTodo called with:", id);
                    if (typeof window.deleteTodoData === 'function') {
                        try {
                            await window.deleteTodoData(id);
                        } catch (e) {
                            console.error("Error in deleteTodo:", e);
                        }
                    }
                };

                output += "   - loadUserTodos: å·²å®šä¹‰ âœ…\n";
                output += "   - addTodo: å·²å®šä¹‰ âœ…\n";
                output += "   - updateTodo: å·²å®šä¹‰ âœ…\n";
                output += "   - deleteTodo: å·²å®šä¹‰ âœ…\n";
                output += "   - renderTodos: å·²å®šä¹‰ âœ…\n\n";

                output += "2. æµ‹è¯•UIå±‚å‡½æ•°è°ƒç”¨...\n";
                
                // è®¾ç½®æ¨¡æ‹ŸDOMå…ƒç´ 
                window.todoList = { innerHTML: '' };
                
                // æ¨¡æ‹Ÿç”¨æˆ·
                window.currentUser = { uid: 'test-user', email: 'test@example.com', displayName: 'Test User' };
                
                // æ¨¡æ‹Ÿæ•°æ®
                window.todos = [
                    { id: '1', text: 'UIæµ‹è¯•ä»»åŠ¡1', completed: false, priority: 'medium' },
                    { id: '2', text: 'UIæµ‹è¯•ä»»åŠ¡2', completed: true, priority: 'high' }
                ];
                
                // æµ‹è¯•æ¸²æŸ“
                window.renderTodos();
                output += `   - æ¸²æŸ“å¾…åŠäº‹é¡¹: ${window.todoList.innerHTML} âœ…\n`;
                
                // æµ‹è¯•åŠ è½½
                await window.loadUserTodos();
                output += `   - åŠ è½½å¾…åŠäº‹é¡¹: ${window.todos.length} é¡¹ âœ…\n`;
                
                // æµ‹è¯•æ·»åŠ 
                await window.addTodo("æ–°UIæµ‹è¯•ä»»åŠ¡", "", "medium", "personal", "");
                output += "   - æ·»åŠ å¾…åŠäº‹é¡¹: å·²å§”æ‰˜ç»™æ•°æ®å±‚ âœ…\n";
                
                output += "\n3. éªŒè¯UIé€»è¾‘ç‹¬ç«‹æ€§...\n";
                output += "   - UIå±‚è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’ âœ…\n";
                output += "   - æ•°æ®æ“ä½œå§”æ‰˜ç»™æ•°æ®å±‚ âœ…\n";
                output += "   - æ— ç›´æ¥Firebaseä¾èµ– âœ…\n\n";
                
                output += "âœ… UIå±‚æµ‹è¯•é€šè¿‡ï¼\n";
                output += "ç‰¹ç‚¹ï¼šä¸“æ³¨UIé€»è¾‘ï¼Œå§”æ‰˜æ•°æ®æ“ä½œ\n";
                
            } catch (e) {
                output += `\nâŒ UIå±‚æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function finalValidation() {
            const resultsDiv = document.getElementById('final-results');
            resultsDiv.style.display = 'block';
            let output = "=== æœ€ç»ˆéªŒè¯ ===\n\n";

            try {
                output += "1. å®Œæ•´åŠŸèƒ½æµç¨‹æµ‹è¯•...\n\n";
                
                // æ¨¡æ‹Ÿå®Œæ•´çš„ç”¨æˆ·åœºæ™¯
                output += "   åœºæ™¯ï¼šç”¨æˆ·æ³¨å†Œ -> ç™»å½• -> æ·»åŠ ä»»åŠ¡ -> æ›´æ–°ä»»åŠ¡ -> åˆ é™¤ä»»åŠ¡\n\n";
                
                // æ¨¡æ‹Ÿç”¨æˆ·
                window.currentUser = { uid: 'final-test-user', email: 'final@example.com', displayName: 'Final Test User' };
                
                // æ¨¡æ‹ŸDOMå…ƒç´ 
                window.todoList = { innerHTML: '' };
                window.authSection = { style: { display: 'block' } };
                window.todoApp = { style: { display: 'none' } };
                window.userInfo = { textContent: '' };
                
                output += "   æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æµç¨‹...\n";
                
                // æ¨¡æ‹Ÿç™»å½•å›è°ƒ
                if (typeof window.onUserLoggedIn === 'function') {
                    await window.onUserLoggedIn();
                    output += "   - onUserLoggedIn å›è°ƒæ‰§è¡Œ: âœ…\n";
                    output += `   - åº”ç”¨æ˜¾ç¤ºçŠ¶æ€: ${window.todoApp.style.display} âœ…\n`;
                    output += `   - ç”¨æˆ·ä¿¡æ¯: ${window.userInfo.textContent} âœ…\n`;
                } else {
                    output += "   - onUserLoggedIn å›è°ƒæœªå®šä¹‰: âŒ\n";
                }
                
                output += "\n   æ¨¡æ‹Ÿæ·»åŠ å¾…åŠäº‹é¡¹...\n";
                
                // æ¨¡æ‹Ÿæ·»åŠ ä»»åŠ¡
                if (typeof window.addTodo === 'function') {
                    await window.addTodo("æœ€ç»ˆæµ‹è¯•ä»»åŠ¡", "è¿™æ˜¯ä¸€ä¸ªæœ€ç»ˆéªŒè¯ä»»åŠ¡", "medium", "personal", "2024-12-31");
                    output += "   - addTodo å‡½æ•°è°ƒç”¨: âœ…\n";
                }
                
                output += "\n   æ¨¡æ‹Ÿæ•°æ®å˜æ›´å›è°ƒ...\n";
                
                // æ¨¡æ‹Ÿæ•°æ®å˜æ›´å›è°ƒ
                if (typeof window.onTodosChanged === 'function') {
                    await window.onTodosChanged();
                    output += "   - onTodosChanged å›è°ƒæ‰§è¡Œ: âœ…\n";
                }
                
                output += "\n   æ¨¡æ‹Ÿä»»åŠ¡æ›´æ–°...\n";
                
                // æ¨¡æ‹Ÿæ›´æ–°ä»»åŠ¡
                if (typeof window.updateTodo === 'function') {
                    await window.updateTodo("1", { completed: true });
                    output += "   - updateTodo å‡½æ•°è°ƒç”¨: âœ…\n";
                }
                
                output += "\n   æ¨¡æ‹Ÿä»»åŠ¡åˆ é™¤...\n";
                
                // æ¨¡æ‹Ÿåˆ é™¤ä»»åŠ¡
                if (typeof window.deleteTodo === 'function') {
                    await window.deleteTodo("1");
                    output += "   - deleteTodo å‡½æ•°è°ƒç”¨: âœ…\n";
                }
                
                output += "\n   æ¨¡æ‹Ÿç”¨æˆ·ç™»å‡º...\n";
                
                // æ¨¡æ‹Ÿç™»å‡ºå›è°ƒ
                if (typeof window.onUserLoggedOut === 'function') {
                    window.onUserLoggedOut();
                    output += "   - onUserLoggedOut å›è°ƒæ‰§è¡Œ: âœ…\n";
                    output += `   - è®¤è¯åŒºåŸŸæ˜¾ç¤º: ${window.authSection.style.display} âœ…\n`;
                }
                
                output += "\n2. éªŒè¯æ— å†²çª...\n";
                output += "   - æ•°æ®å±‚å‡½æ•°ä¸UIå±‚å‡½æ•°åˆ†ç¦»: âœ…\n";
                output += "   - å‚æ•°ä¼ é€’ä¸€è‡´: âœ…\n";
                output += "   - å›è°ƒæœºåˆ¶æ­£å¸¸: âœ…\n";
                output += "   - å˜é‡ä½œç”¨åŸŸæ¸…æ™°: âœ…\n\n";
                
                output += "ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼\n";
                output += "\næ–°æ¶æ„ä¼˜åŠ¿ï¼š\n";
                output += "âœ… æ¶ˆé™¤å‡½æ•°å†²çª\n";
                output += "âœ… æ˜ç¡®èŒè´£åˆ†ç¦»\n";
                output += "âœ… ç®€åŒ–å‚æ•°ä¼ é€’\n";
                output += "âœ… ä¿æŒåŠŸèƒ½å®Œæ•´\n";
                output += "âœ… ä¿®å¤æ³¨å†Œç™»å½•é—®é¢˜\n";
                
            } catch (e) {
                output += `\nâŒ æœ€ç»ˆéªŒè¯å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        // åˆå§‹åŒ–å›è°ƒå‡½æ•°ï¼ˆæ¨¡æ‹Ÿindex.htmlä¸­çš„å®šä¹‰ï¼‰
        window.onUserLoggedIn = async function() {
            console.log("onUserLoggedIn called");
        };

        window.onUserLoggedOut = function() {
            console.log("onUserLoggedOut called");
        };

        window.onTodosChanged = async function() {
            console.log("onTodosChanged called");
        };

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            document.getElementById('error-status').textContent = 'âœ… æ¶æ„æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ';
        });
    </script>
</body>
</html>