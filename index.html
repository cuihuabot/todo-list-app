<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Multi-User Todo List with Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --light: #f2f2f7;
            --dark: #1c1c1e;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FFCC00;
            --info: #5AC8FA;
            --system-gray: #8e8e93;
            --system-gray2: #aeaeb2;
            --system-gray3: #c7c7cc;
            --system-gray4: #d1d1d6;
            --system-gray5: #e5e5ea;
            --system-gray6: #f2f2f7;
            --card-bg: #ffffff;
            --card-border: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        .container:hover {
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .header-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .user-info {
            color: white;
            font-size: 14px;
            margin-left: 10px;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .controls {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-group button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .input-group button:hover {
            background: #5a67d8;
        }

        .filters {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .filters button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .filters button.active {
            background: var(--primary);
            color: white;
        }

        .view-controls {
            display: flex;
            gap: 5px;
        }


        .bulk-actions {
            display: flex;
            gap: 5px;
        }

        .bulk-actions button {
            padding: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .bulk-actions button:hover {
            background: #f0f0f0;
        }

        .todo-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
            border-radius: 6px;
        }

        .selected {
            background-color: rgba(0, 122, 255, 0.1) !important;
            border: 1px solid var(--primary) !important;
        }







        .advanced-filters {
            padding: 0 20px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
        }

        .filter-group select {
            padding: 5px;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
        }

        .todo-list {
            padding: 0 20px 20px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border: 1px solid var(--system-gray5);
            border-radius: 12px;
            margin-bottom: 12px;
            background: var(--card-bg);
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .todo-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
            border-color: var(--system-gray4);
        }

        .todo-item.completed {
            opacity: 0.8;
            background-color: var(--system-gray6);
            border-color: var(--system-gray4);
            text-decoration: line-through;
        }

        .todo-item.overdue {
            border-left: 4px solid var(--danger);
        }

        /* Tiimo-style completion animation */
        .todo-item.completing {
            animation: completeAnimation 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes completeAnimation {
            0% {
                transform: scale(1);
                border-color: var(--primary);
            }
            30% {
                transform: scale(1.02);
                opacity: 0.9;
                border-color: var(--success);
            }
            70% {
                transform: scale(0.98);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 0.8;
                border-left: 4px solid var(--success);
            }
        }

        /* Checkbox animation */
        .todo-checkbox {
            transition: all 0.3s ease;
        }

        .todo-checkbox:checked {
            background-color: var(--success);
            transform: scale(1.1);
            box-shadow: 0 0 0 2px var(--success);
        }

        /* Ripple effect for completion */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(52, 199, 89, 0.4);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .todo-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .todo-item.completed {
            opacity: 0.7;
        }

        .todo-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .todo-content {
            flex: 1;
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .todo-title {
            font-size: 16px;
            font-weight: bold;
            flex: 1;
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: #718096;
        }

        .todo-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #666;
        }

        .todo-priority {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .priority-high { 
            background: rgba(255, 60, 48, 0.15); 
            color: #FF2D1F; 
        }
        .priority-medium { 
            background: rgba(255, 204, 0, 0.15); 
            color: #FFCC00; 
        }
        .priority-low { 
            background: rgba(52, 199, 89, 0.15); 
            color: #34C759; 
        }

        .todo-category {
            padding: 2px 6px;
            background: #e2e8f0;
            border-radius: 3px;
            font-size: 10px;
        }

        .todo-due {
            color: #e53e3e;
            font-weight: bold;
        }

        .todo-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            display: none;
        }

        .todo-item.show-description .todo-description {
            display: block;
        }

        .todo-actions {
            display: flex;
            gap: 5px;
        }

        .todo-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .edit-btn {
            background: #ffd700;
            color: black;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .detail-btn {
            background: #bee3f8;
            color: #2c5282;
        }

        .stats {
            padding: 15px 20px;
            background: var(--light);
            border-top: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: var(--dark);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 10px;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            backdrop-filter: blur(10px);
            font-size: 16px;
        }

        .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            backdrop-filter: blur(10px);
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Dark Mode Styles */
        .dark-mode {
            --dark: #f2f2f7;
            --light: #1c1c1e;
            --card-bg: #1c1c1e;
            --card-border: rgba(255, 255, 255, 0.1);
        }

        .dark-mode body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f2f2f7;
        }

        .dark-mode .container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        .dark-mode .todo-item {
            background: var(--card-bg);
            border-color: var(--system-gray3);
        }

        .dark-mode .todo-item.completed {
            background-color: #2c2c2e;
            border-color: #48484a;
        }

        .dark-mode .input-group input {
            background: #2c2c2e;
            border-color: #48484a;
            color: #f2f2f7;
        }

        .dark-mode .filters button,
        .dark-mode .view-controls button,
        .dark-mode .bulk-actions button {
            background: #2c2c2e;
            color: #f2f2f7;
            border-color: #48484a;
        }

        .dark-mode .filters button.active,

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .search-bar {
            padding: 0 20px 10px;
        }

        .search-bar input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }

        .auth-section {
            display: block;
            padding: 40px;
            text-align: center;
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: left;
        }

        .auth-form .form-group {
            margin-bottom: 15px;
        }

        .auth-toggle {
            margin-top: 15px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .nav-bar {
            display: flex;
            background: var(--card-bg);
            border-top: 1px solid var(--card-border);
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            cursor: pointer;
            color: var(--system-gray);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 12px;
        }

        .tab-content {
            padding-bottom: 60px; /* Space for nav bar */
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
            padding: 20px;
        }

        .tab-pane.active {
            display: block;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .today-schedule {
            margin-top: 20px;
        }

        .time-block {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .time-block h3 {
            margin: 0;
            padding: 15px;
            background: var(--system-gray6);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .time-block-content {
            padding: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--system-gray);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .user-card {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border);
        }

        .user-avatar {
            font-size: 48px;
            margin-right: 15px;
            color: var(--primary);
        }

        .user-info-detail h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .user-info-detail p {
            margin: 0;
            color: var(--system-gray);
            font-size: 14px;
        }

        .edit-profile-btn {
            margin-left: auto;
            background: var(--primary);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievements-section {
            margin-bottom: 25px;
        }

        .achievement-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .achievement-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            border: 1px solid var(--card-border);
        }

        .achievement-icon {
            font-size: 24px;
            color: var(--primary);
            margin-right: 10px;
        }

        .achievement-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .achievement-label {
            font-size: 12px;
            color: var(--system-gray);
        }

        .reflection-section {
            margin-bottom: 25px;
        }

        .reflection-entry textarea {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            min-height: 100px;
            font-family: inherit;
            margin-bottom: 10px;
            resize: vertical;
        }

        .profile-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .profile-actions .logout-btn {
            width: auto;
            margin: 0;
        }
        
        .logout-confirm-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .logout-confirm-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        
        .logout-warning {
            color: #e53e3e;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .logout-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .input-group {
                flex-direction: column;
            }

            .filters, .view-controls {
                justify-content: center;
            }

            .advanced-filters {
                grid-template-columns: 1fr;
            }
            
            .achievement-cards {
                grid-template-columns: 1fr;
            }
            
            .profile-actions {
                grid-template-columns: 1fr;
            }
            
            /* Mobile-friendly modal styles */
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
                max-height: 85vh;
            }
            
            .modal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .close {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px; /* Better touch target for mobile */
            }
            
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions button {
                width: 100%;
            }
        }
        
        /* Additional mobile optimizations for very small screens */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 10px auto;
            }
            
            .modal-content {
                width: 98%;
                margin: 5% auto;
                padding: 12px;
            }
            
            .header {
                padding: 15px;
            }
            
            .search-bar input,
            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 12px;
            }
            
            .todo-item {
                padding: 12px 15px;
            }
            
            .nav-bar {
                padding: 5px 0;
            }
            
            .nav-item {
                padding: 8px 0;
            }
            
            .nav-item i {
                font-size: 18px;
            }
            
            .nav-item span {
                font-size: 10px;
            }
        }
        
        /* Mobile input focus adjustments */
        @media (max-width: 768px) {
            body.input-focused {
                height: 100%;
                overflow: visible;
            }
            
            .input-focused .modal-content {
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="container auth-section">
        <h2>üìã Multi-User Todo List</h2>
        <p>ÁôªÂΩïÊàñÊ≥®ÂÜå‰ª•ÂºÄÂßã‰ΩøÁî®</p>

        <div class="auth-form">
            <div id="loginFormContainer">
                <h3>ÁôªÂΩï</h3>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">ÈÇÆÁÆ±</label>
                        <input type="email" id="loginEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">ÂØÜÁ†Å</label>
                        <input type="password" id="loginPassword" name="password" required>
                    </div>
                    <button type="submit" class="btn-primary">ÁôªÂΩï</button>
                </form>

                <div class="auth-toggle">
                    <p>ËøòÊ≤°ÊúâË¥¶Êà∑Ôºü <a href="#" onclick="window.showRegisterForm()">Á´ãÂç≥Ê≥®ÂÜå</a></p>
                </div>
            </div>

            <div id="registerFormContainer" style="display: none;">
                <h3>Ê≥®ÂÜå</h3>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerDisplayName">ÊòæÁ§∫ÂêçÁß∞</label>
                        <input type="text" id="registerDisplayName" name="displayName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ÈÇÆÁÆ±</label>
                        <input type="email" id="registerEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">ÂØÜÁ†Å</label>
                        <input type="password" id="registerPassword" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Á°ÆËÆ§ÂØÜÁ†Å</label>
                        <input type="password" id="registerConfirmPassword" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn-primary">Ê≥®ÂÜå</button>
                </form>

                <div class="auth-toggle">
                    <p>Â∑≤ÊúâË¥¶Êà∑Ôºü <a href="#" onclick="window.showLoginForm()">Á´ãÂç≥ÁôªÂΩï</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="todoApp" class="container" style="display: none; max-width: 100%; margin: 0; border-radius: 0; height: 100vh; max-height: 100vh; overflow: hidden;">
        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="window.switchTab('todo')">
                <i class="fas fa-list"></i>
                <span>ÂæÖÂäû</span>
            </div>
            <div class="nav-item" onclick="window.switchTab('today')">
                <i class="fas fa-calendar-day"></i>
                <span>‰ªäÂ§©</span>
            </div>
            <div class="nav-item" onclick="window.switchTab('profile')">
                <i class="fas fa-user"></i>
                <span>ÊàëÁöÑ</span>
            </div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- To-Do List Tab -->
            <div id="todo-tab" class="tab-pane active">
                <div class="header">
                    <div>
                        <h1>üìã ÂæÖÂäû‰∫ãÈ°π</h1>
                        <p>È´òÊïàÂÆåÊàêÊØè‰∏ÄÈ°π‰ªªÂä°</p>
                    </div>
                    <div class="header-actions">
                        <button type="button" class="action-btn" onclick="window.showAddModal()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" class="action-btn" onclick="window.toggleSortMenu()">
                            <i class="fas fa-sort"></i>
                        </button>
                    </div>
                </div>
                
                <div class="controls">
                </div>

                <div class="todo-list" id="todoTabTodoList">
                    <div class="loading" id="todoTabLoadingIndicator">
                        <i class="fas fa-spinner fa-spin"></i> Âä†ËΩΩ‰∏≠...
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="todoTabTotalCount">0</div>
                        <div>ÊÄªËÆ°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todoTabActiveCount">0</div>
                        <div>ÂæÖÂäû</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todoTabCompletedCount">0</div>
                        <div>ÂÆåÊàê</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todoTabOverdueCount">0</div>
                        <div>ÈÄæÊúü</div>
                    </div>
                </div>
            </div>

            <!-- Today's Schedule Tab -->
            <div id="today-tab" class="tab-pane">
                <div class="header">
                    <div>
                        <h1>üìÖ ‰ªäÂ§©</h1>
                        <p>‰ªäÊó•Êó∂Èó¥ËßÑÂàí</p>
                    </div>
                    <div class="header-actions">
                        <button type="button" class="action-btn" onclick="window.toggleFocusMode()">
                            <i class="fas fa-bullseye"></i>
                        </button>
                        <button type="button" class="action-btn" onclick="window.triggerMagicFeature()">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                </div>
                
                <div class="today-schedule">
                    <div class="time-block">
                        <h3><i class="fas fa-clock"></i> ÈöèÊó∂</h3>
                        <div class="time-block-content">
                            <div class="empty-state">
                                <i class="fas fa-dove"></i>
                                <p>‰Ω†‰ªäÂ§©Êúâ‰ªÄ‰πàËÆ°ÂàíÔºü</p>
                                <button type="button" class="btn-primary" onclick="window.showAddModal()">Ê∑ªÂä†‰ªªÂä°</button>
                            </div>
                        </div>
                    </div>
                    <div class="time-block">
                        <h3><i class="fas fa-sun"></i> ‰∏äÂçà</h3>
                        <div class="time-block-content">
                            <div class="empty-state">
                                <i class="fas fa-coffee"></i>
                                <p>‰∏äÂçàÂÆâÊéí‰ªÄ‰πàÔºü</p>
                                <button type="button" class="btn-primary" onclick="window.showAddModal()">Ê∑ªÂä†‰ªªÂä°</button>
                            </div>
                        </div>
                    </div>
                    <div class="time-block">
                        <h3><i class="fas fa-sun"></i> ÁôΩÂ§©</h3>
                        <div class="time-block-content">
                            <div class="empty-state">
                                <i class="fas fa-umbrella-beach"></i>
                                <p>ÁôΩÂ§©Êúâ‰ªÄ‰πàÂÆâÊéíÔºü</p>
                                <button type="button" class="btn-primary" onclick="window.showAddModal()">Ê∑ªÂä†‰ªªÂä°</button>
                            </div>
                        </div>
                    </div>
                    <div class="time-block">
                        <h3><i class="fas fa-moon"></i> Êôö‰∏ä</h3>
                        <div class="time-block-content">
                            <div class="empty-state">
                                <i class="fas fa-bed"></i>
                                <p>Êôö‰∏äËÆ°Âàí‰ªÄ‰πàÔºü</p>
                                <button type="button" class="btn-primary" onclick="window.showAddModal()">Ê∑ªÂä†‰ªªÂä°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-pane">
                <div class="header">
                    <div>
                        <h1>üë§ ÊàëÁöÑ</h1>
                        <p>‰∏™‰∫∫‰∏≠ÂøÉ</p>
                    </div>
                    <div class="header-actions">
                        <button type="button" class="action-btn" onclick="window.shareAchievements()">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="profile-content">
                    <div class="user-card">
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-info-detail">
                            <h3 id="profileTabDisplayName">Áî®Êà∑Âêç</h3>
                            <p id="profileTabEmail">ÈÇÆÁÆ±</p>
                        </div>
                        <button type="button" class="edit-profile-btn" onclick="window.showProfileModal()">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    
                    <div class="achievements-section">
                        <h3>üèÜ ÊàêÂ∞±Á≥ªÁªü</h3>
                        <div class="achievement-cards">
                            <div class="achievement-card">
                                <div class="achievement-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="achievement-text">
                                    <div class="achievement-value" id="profileTabConsecutiveDays">0</div>
                                    <div class="achievement-label">ËøûÁª≠ËßÑÂàíÂ§©Êï∞</div>
                                </div>
                            </div>
                            <div class="achievement-card">
                                <div class="achievement-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="achievement-text">
                                    <div class="achievement-value" id="profileTabTotalTasks">0</div>
                                    <div class="achievement-label">ÊÄª‰ªªÂä°Êï∞</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="reflection-section">
                        <h3>üí≠ ÊØèÂë®ÊÄªÁªì</h3>
                        <div class="reflection-entry">
                            <textarea id="profileTabReflectionTextarea" placeholder="ËÆ∞ÂΩïÊú¨Âë®ÁöÑÂèçÊÄùÊàñÂøÉÊÉÖ..."></textarea>
                            <button type="button" class="btn-primary" onclick="window.saveReflection()">‰øùÂ≠òËÆ∞ÂΩï</button>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button type="button" class="btn-secondary" onclick="window.exportData()">ÂØºÂá∫Êï∞ÊçÆ</button>
                        <button type="button" class="logout-btn" style="background: #e53e3e;" onclick="window.logout()">ÁôªÂá∫</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add/Edit Modal -->
    <div id="todoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Ê∑ªÂä†‰ªªÂä°</div>
                <span class="close" onclick="window.closeModal()">&times;</span>
            </div>
            <form id="todoForm">
                <div class="form-group">
                    <label for="modalTitleInput">Ê†áÈ¢ò *</label>
                    <input type="text" id="modalTitleInput" required>
                </div>
                <div class="form-group">
                    <label for="modalDescription">ÊèèËø∞</label>
                    <textarea id="modalDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="modalPriority">‰ºòÂÖàÁ∫ß</label>
                    <select id="modalPriority">
                        <option value="low">‰Ωé</option>
                        <option value="medium" selected>‰∏≠</option>
                        <option value="high">È´ò</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalCategory">ÂàÜÁ±ª</label>
                    <select id="modalCategory">
                        <option value="personal">‰∏™‰∫∫</option>
                        <option value="work">Â∑•‰Ωú</option>
                        <option value="shopping">Ë¥≠Áâ©</option>
                        <option value="health">ÂÅ•Â∫∑</option>
                        <option value="learning">Â≠¶‰π†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalDueDate">Âà∞ÊúüÊó∂Èó¥</label>
                    <input type="date" id="modalDueDate">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‰∏™‰∫∫‰ø°ÊÅØ</div>
                <span class="close" onclick="window.closeProfileModal()">&times;</span>
            </div>
            <div id="profileContent">
                <div class="form-group">
                    <label for="displayNameInput">ÊòæÁ§∫ÂêçÁß∞</label>
                    <input type="text" id="displayNameInput" placeholder="ËæìÂÖ•ÊòæÁ§∫ÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label for="emailInput">ÈÇÆÁÆ±</label>
                    <input type="email" id="emailInput" readonly placeholder="ÈÇÆÁÆ±Âú∞ÂùÄ">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.closeProfileModal()">ÂÖ≥Èó≠</button>
                    <button type="button" class="btn-primary" onclick="window.updateProfile()">‰øùÂ≠ò</button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <h3>‰øÆÊîπÂØÜÁ†Å</h3>
                <div class="form-group">
                    <label for="currentPassword">ÂΩìÂâçÂØÜÁ†Å</label>
                    <input type="password" id="currentPassword" placeholder="ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å">
                </div>
                <div class="form-group">
                    <label for="newPassword">Êñ∞ÂØÜÁ†Å</label>
                    <input type="password" id="newPassword" placeholder="ËæìÂÖ•Êñ∞ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Á°ÆËÆ§Êñ∞ÂØÜÁ†Å</label>
                    <input type="password" id="confirmNewPassword" placeholder="ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.closeProfileModal()">ÂÖ≥Èó≠</button>
                    <button type="button" class="btn-primary" onclick="window.changePassword()">‰øÆÊîπÂØÜÁ†Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // State management - Â∞ÜcurrentUserËÆæ‰∏∫ÂÖ®Â±Ä‰ª•‰æøÂú®Â§ñÈÉ®JSÊñá‰ª∂‰∏≠ËÆøÈóÆ
        window.todos = [];
        window.currentFilter = 'all';
        window.currentView = 'list';
        window.editingId = null;
        window.currentUser = null;  // ËÆæ‰∏∫ÂÖ®Â±ÄÂèòÈáèÔºå‰ª•‰æøfirebase-config.js‰∏≠ËÆøÈóÆ
        window.filters = {
            priority: '',
            category: '',
            dueDate: '',
            search: ''
        };

        // DOM Elements - Âè™Âú®ËøôÈáåÂ£∞Êòé‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈáçÂ§çÂ£∞Êòé
        window.authSection = document.getElementById('authSection');
        window.todoApp = document.getElementById('todoApp');
        window.userInfo = document.getElementById('userInfo');
        window.loginForm = document.getElementById('loginForm');
        window.registerForm = document.getElementById('registerForm');
        window.loginFormContainer = document.getElementById('loginFormContainer');
        window.registerFormContainer = document.getElementById('registerFormContainer');
        // Note: Using the new todo tab's todo list container
        window.todoList = document.getElementById('todoTabTodoList');
        // Note: Using the new todo tab's loading indicator
        window.loadingIndicator = document.getElementById('todoTabLoadingIndicator');

        // Form handlers
        // ÂàùÂßãÂåñËÆ§ËØÅÂ§ÑÁêÜÂô®Ôºå‰º†ÂÖ•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†
        if (window.loginForm && window.registerForm) {
            window.setupAuthHandlers(
                window.loginForm,
                window.registerForm,
                window.todoApp,
                window.authSection,
                window.userInfo,
                window.todoList
            );
        }

        // Show registration form
        function showRegisterForm() {
            if (window.loginFormContainer) window.loginFormContainer.style.display = 'none';
            if (window.registerFormContainer) window.registerFormContainer.style.display = 'block';
        }

        // Show login form
        function showLoginForm() {
            if (window.registerFormContainer) window.registerFormContainer.style.display = 'none';
            if (window.loginFormContainer) window.loginFormContainer.style.display = 'block';
        }

        // Load user's todos from Firestore (using data layer)
        async function loadUserTodos() {
            if (!window.currentUser) return;

            try {
                // Use the data layer function
                window.todos = await window.loadUserTodosData();

                renderTodos();
                updateStats();

                const loadingIndicator = document.getElementById('todoTabLoadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading todos:', error);
                const loadingIndicator = document.getElementById('todoTabLoadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<p>Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï</p>';
                }
            }
        }

        // Add a new todo (using data layer)
        async function addTodo(text, description = '', priority = 'medium', category = 'personal', dueDate = '') {
            if (!window.currentUser || !text.trim()) return;

            try {
                await window.addTodoData(text, description, priority, category, dueDate);
                // The data layer will trigger refresh via callback
            } catch (error) {
                console.error('Error adding todo:', error);
                alert('Ê∑ªÂä†‰ªªÂä°Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Update a todo (using data layer)
        async function updateTodo(id, updates) {
            if (!window.currentUser || !id) return;

            try {
                await window.updateTodoData(id, updates);
                // The data layer will trigger refresh via callback
            } catch (error) {
                console.error('Error updating todo:', error);
                alert('Êõ¥Êñ∞‰ªªÂä°Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Delete a todo (using data layer)
        async function deleteTodo(id) {
            if (!window.currentUser || !id) return;

            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;

            try {
                await window.deleteTodoData(id);
                // The data layer will trigger refresh via callback
            } catch (error) {
                console.error('Error deleting todo:', error);
                alert('Âà†Èô§‰ªªÂä°Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Toggle todo completion with Tiimo-style animation (using data layer)
        async function toggleTodo(id) {
            const todo = window.todos.find(t => t.id === id);
            if (!todo) return;

            try {
                // Add completing animation class before updating
                const todoElement = document.querySelector(`.todo-item[data-id="${id}"]`);
                if (todoElement) {
                    todoElement.classList.add('completing');
                    
                    // Add ripple effect
                    addRippleEffect(todoElement, event);
                }

                // Add slight delay for animation to be visible
                setTimeout(async () => {
                    try {
                        await window.updateTodoData(id, {
                            completed: !todo.completed,
                            completedAt: !todo.completed ? firebase.firestore.FieldValue.serverTimestamp() : null
                        });
                    } catch (error) {
                        console.error('Error toggling todo:', error);
                        alert('Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        
                        // Remove animation class if update fails
                        if (todoElement) {
                            todoElement.classList.remove('completing');
                        }
                    }
                }, 150);
            } catch (error) {
                console.error('Error in toggleTodo:', error);
            }
        }

        // Handle todo toggle with event for ripple effect
        function handleTodoToggle(event, id) {
            // Call toggleTodo with event for ripple effect
            toggleTodo(id);
        }

        // Add ripple effect for visual feedback
        function addRippleEffect(element, event) {
            // Create ripple element
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            
            // Position the ripple at the click location
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = (event?.clientX - rect.left) || (rect.width / 2);
            const y = (event?.clientY - rect.top) || (rect.height / 2);
            
            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x - (size / 2)}px`;
            ripple.style.top = `${y - (size / 2)}px`;
            
            // Add ripple to the element
            element.style.position = 'relative';
            element.appendChild(ripple);
            
            // Remove ripple after animation completes
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Render todos based on current filters
        function renderTodos() {
            // Use the todo tab's todo list container
            const todoListContainer = document.getElementById('todoTabTodoList');
            if (!todoListContainer) return;

            let filteredTodos = [...window.todos];

            // Apply filters
            filteredTodos = filteredTodos.filter(todo => {
                // Basic filter
                if (window.currentFilter === 'active') return !todo.completed;
                if (window.currentFilter === 'completed') return todo.completed;
                return true;
            });

            // Note: Advanced filters (priority, category, due date, search) have been removed
            // Only basic filtering (active/completed) remains

            // Render todos based on current view
            if (filteredTodos.length === 0) {
                todoListContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p>üéâ ${window.currentFilter === 'all' ? 'ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π' :
                              window.currentFilter === 'active' ? 'ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π' :
                              'ÊöÇÊó†Â∑≤ÂÆåÊàê‰∫ãÈ°π'}</p>
                        <p>${window.currentFilter === 'all' ? 'Ê∑ªÂä†‰∏Ä‰∫õ‰ªªÂä°ÂºÄÂßãÂêßÔºÅ' : ''}</p>
                    </div>
                `;
                return;
            }

            // Different rendering based on view type
            if (window.currentView === 'timeline') {
                // Sort by due date for timeline view
                const sortedTodos = sortTodosByDate([...filteredTodos]);
                
                todoListContainer.innerHTML = `
                    <div class="timeline-container">
                        <div class="timeline-line"></div>
                        ${sortedTodos.map(todo => {
                            const isOverdue = todo.dueDate && new Date(todo.dueDate) < new Date() && !todo.completed;
                            const dueDateStr = todo.dueDate ? formatDate(todo.dueDate) : '';
                            
                            return `
                                <div class="timeline-item ${todo.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${todo.id}">
                                    <div class="timeline-marker"></div>
                                    ${todo.dueDate ? `<div class="timeline-date">${dueDateStr}</div>` : ''}
                                    <input type="checkbox" class="todo-checkbox"
                                           ${todo.completed ? 'checked' : ''}
                                           onchange="window.toggleTodo('${todo.id}'); window.toggleTodoSelection(this, '${todo.id}')" 
                                           onclick="window.handleTodoToggle(event, '${todo.id}')">
                                    <div class="todo-content">
                                        <div class="todo-header">
                                            <div class="todo-title">${todo.text}</div>
                                            <div class="todo-meta">
                                                <span class="todo-priority priority-${todo.priority}">${todo.priority}</span>
                                                <span class="todo-category">${todo.category}</span>
                                                ${todo.dueDate ? `<span class="todo-due"><i class="far fa-calendar"></i> ${dueDateStr}</span>` : ''}
                                            </div>
                                        </div>
                                        ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                                    </div>
                                    <div class="todo-actions">
                                        <button class="detail-btn" onclick="window.toggleDescription('${todo.id}')">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="edit-btn" onclick="window.showAddModal(${JSON.stringify(todo).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-btn" onclick="window.deleteTodo('${todo.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // Regular list or grid view
                todoListContainer.innerHTML = filteredTodos.map(todo => {
                    const isOverdue = todo.dueDate && new Date(todo.dueDate) < new Date() && !todo.completed;
                    const dueDateStr = todo.dueDate ? formatDate(todo.dueDate) : '';
                    const createdAtStr = todo.createdAt ? formatDate(todo.createdAt.toDate ? todo.createdAt.toDate() : todo.createdAt) : '';

                    return `
                        <div class="todo-item ${todo.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${todo.id}">
                            <input type="checkbox" class="todo-checkbox"
                                   ${todo.completed ? 'checked' : ''}
                                   onchange="window.toggleTodo('${todo.id}'); window.toggleTodoSelection(this, '${todo.id}')">
                            <div class="todo-content">
                                <div class="todo-header">
                                    <div class="todo-title">${todo.text}</div>
                                    <div class="todo-meta">
                                        <span class="todo-priority priority-${todo.priority}">${todo.priority}</span>
                                        <span class="todo-category">${todo.category}</span>
                                        ${todo.dueDate ? `<span class="todo-due"><i class="far fa-calendar"></i> ${dueDateStr}</span>` : ''}
                                    </div>
                                </div>
                                ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                            </div>
                            <div class="todo-actions">
                                <button class="detail-btn" onclick="window.toggleDescription('${todo.id}')">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="edit-btn" onclick="window.showAddModal(${JSON.stringify(todo).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="window.deleteTodo('${todo.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Format date
        function formatDate(date) {
            if (date instanceof Date) {
                return date.toLocaleDateString('zh-CN');
            }
            return new Date(date).toLocaleDateString('zh-CN');
        }

        // Toggle description visibility
        function toggleDescription(id) {
            const element = document.querySelector(`[data-id="${id}"]`);
            element.classList.toggle('show-description');
        }

        // Update statistics
        function updateStats() {
            const totalCount = window.todos.length;
            const completedCount = window.todos.filter(todo => todo.completed).length;
            const activeCount = totalCount - completedCount;
            const overdueCount = window.todos.filter(todo => {
                return todo.dueDate &&
                       new Date(todo.dueDate) < new Date() &&
                       !todo.completed;
            }).length;

            // Only update the new multi-tab UI stats
            const totalEl = document.getElementById('todoTabTotalCount');
            const completedEl = document.getElementById('todoTabCompletedCount');
            const activeEl = document.getElementById('todoTabActiveCount');
            const overdueEl = document.getElementById('todoTabOverdueCount');
            
            if (totalEl) totalEl.textContent = totalCount;
            if (completedEl) completedEl.textContent = completedCount;
            if (activeEl) activeEl.textContent = activeCount;
            if (overdueEl) overdueEl.textContent = overdueCount;
        }

        // Filter todos - simplified as filter buttons are removed
        function filterTodos(filter) {
            window.currentFilter = filter;
            renderTodos();
        }

        // Change view

        // Sort todos by due date for timeline view

        // Apply filters
        function applyFilters() {
            window.filters.priority = document.getElementById('priorityFilter').value;
            window.filters.category = document.getElementById('categoryFilter').value;
            window.filters.dueDate = document.getElementById('dueDateFilter').value;

            renderTodos();
        }

        // Handle search - removed as search functionality is disabled
        function handleSearch() {
            // Search functionality has been removed
        }

        // Show add/edit modal
        function showAddModal(todo = null) {
            window.editingId = todo ? todo.id : null;

            if (todo) {
                document.getElementById('modalTitle').textContent = 'ÁºñËæë‰ªªÂä°';
                document.getElementById('modalTitleInput').value = todo.text || '';
                document.getElementById('modalDescription').value = todo.description || '';
                document.getElementById('modalPriority').value = todo.priority || 'medium';
                document.getElementById('modalCategory').value = todo.category || 'personal';
                document.getElementById('modalDueDate').value = todo.dueDate || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†‰ªªÂä°';
                document.getElementById('modalTitleInput').value = '';
                document.getElementById('modalDescription').value = '';
                document.getElementById('modalPriority').value = 'medium';
                document.getElementById('modalCategory').value = 'personal';
                document.getElementById('modalDueDate').value = '';
            }

            document.getElementById('todoModal').style.display = 'block';
            document.getElementById('modalTitleInput').focus();
        }

        // Close modal
        function closeModal() {
            document.getElementById('todoModal').style.display = 'none';
            window.editingId = null;
        }

        // Handle form submission for add/edit
        document.getElementById('todoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('modalTitleInput').value.trim();
            const description = document.getElementById('modalDescription').value.trim();
            const priority = document.getElementById('modalPriority').value;
            const category = document.getElementById('modalCategory').value;
            const dueDate = document.getElementById('modalDueDate').value;

            if (!title) return;

            if (window.editingId) {
                // Update existing todo
                await window.updateTodo(window.editingId, {
                    text: title,
                    description,
                    priority,
                    category,
                    dueDate
                });
            } else {
                // Add new todo
                await window.addTodo(title, description, priority, category, dueDate);
            }

            closeModal();
        });

        // Handle search input - removed as search functionality is disabled

        // Handle quick add - removed as this is part of old UI that was deleted
        function handleQuickAdd(e) {
            // This function is not used in the new multi-tab UI
            // Quick add functionality has been moved to the add modal
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('todoModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Show the app after login
        function showApp() {
            if (window.authSection) window.authSection.style.display = 'none';
            if (window.todoApp) window.todoApp.style.display = 'block';
            if (window.userInfo) window.userInfo.textContent = `Ê¨¢Ëøé, ${window.currentUser.displayName || window.currentUser.email}`;
        }

        // Logout confirmation function
        function showLogoutConfirmation() {
            // Create confirmation modal if it doesn't exist
            let modal = document.getElementById('logoutConfirmModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'logoutConfirmModal';
                modal.className = 'logout-confirm-modal';
                modal.innerHTML = `
                    <div class="logout-confirm-content">
                        <div class="logout-warning">‚ö†Ô∏è</div>
                        <h3>Á°ÆËÆ§ÈÄÄÂá∫ÁôªÂΩï</h3>
                        <p>ÊÇ®Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçË¥¶Êà∑ÂêóÔºü</p>
                        <div class="logout-buttons">
                            <button type="button" class="btn-secondary" onclick="hideLogoutConfirmation()">ÂèñÊ∂à</button>
                            <button type="button" class="btn-primary" onclick="performLogout()">Á°ÆËÆ§ÈÄÄÂá∫</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.style.display = 'block';
        }
        
        // Hide logout confirmation
        function hideLogoutConfirmation() {
            const modal = document.getElementById('logoutConfirmModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Perform actual logout
        async function performLogout() {
            hideLogoutConfirmation();
            
            if (!auth) {
                console.error('Firebase auth not initialized');
                alert('ËÆ§ËØÅÊúçÂä°Êú™ÂàùÂßãÂåñÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }
            
            try {
                await auth.signOut();
                window.currentUser = null;
                window.todos = [];

                if (window.authSection) window.authSection.style.display = 'block';
                if (window.todoApp) window.todoApp.style.display = 'none';

                // Reset forms
                if (window.loginForm) window.loginForm.reset();
                if (window.registerForm) window.registerForm.reset();
            } catch (error) {
                console.error('Error signing out:', error);
                alert('ÈÄÄÂá∫ÁôªÂΩïÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Logout function (now shows confirmation)
        function logout() {
            showLogoutConfirmation();
        }

        // Initialize search event listener - removed as search functionality is disabled

        // Global variable to hold session manager
        let sessionManager;

        // Check for stored authentication state on page load
        async function checkStoredAuthState() {
            // With IndexedDB implementation, we rely primarily on Firebase's built-in persistence
            // but we can enhance it with our custom IndexedDB storage
            if (window.currentUser) {
                // User is already logged in via Firebase
                window.onUserLoggedIn();
            } else {
                // Check if we have stored session data in IndexedDB
                // Initialize session manager if not already done
                if (typeof SessionManager !== 'undefined' && !sessionManager) {
                    sessionManager = new SessionManager();
                }
                
                // Wait for Firebase to restore session if available
                console.log("Waiting for Firebase to restore session...");
            }
        }

        // Global variable to hold session manager
        let sessionManager;

        // Callbacks for data layer to notify UI layer
        window.onUserLoggedIn = async function() {
            await loadUserTodos();
            if (window.authSection && window.todoApp && window.userInfo && window.currentUser) {
                window.authSection.style.display = 'none';
                window.todoApp.style.display = 'block';
                window.userInfo.textContent = `Ê¨¢Ëøé, ${window.currentUser.displayName || window.currentUser.email}`;
                
                // Store user info in IndexedDB for persistence
                const userObj = {
                    uid: window.currentUser.uid,
                    email: window.currentUser.email,
                    displayName: window.currentUser.displayName
                };
                
                // Initialize session manager if not already done
                if (typeof window.SessionManager !== 'undefined' && !sessionManager) {
                    sessionManager = new window.SessionManager();
                }
                
                // Store the session
                if (sessionManager) {
                    try {
                        await sessionManager.storeSession(userObj);
                        console.log("Session stored in IndexedDB successfully");
                    } catch (error) {
                        console.error("Error storing session in IndexedDB:", error);
                    }
                }
                
                // Restore the last visited page
                if (sessionManager) {
                    try {
                        const pageState = await sessionManager.getPageState(window.currentUser.uid);
                        if (pageState && pageState.currentPage) {
                            switchTab(pageState.currentPage);
                        } else {
                            // Default to todo tab if no previous state
                            switchTab('todo');
                        }
                    } catch (error) {
                        console.error("Error getting page state:", error);
                        switchTab('todo'); // Default fallback
                    }
                } else {
                    switchTab('todo'); // Default fallback
                }
            }
        };

        window.onUserLoggedOut = function() {
            window.todos = [];
            renderTodos();
            if (window.authSection && window.todoApp) {
                window.authSection.style.display = 'block';
                window.todoApp.style.display = 'none';
            }
            if (window.loginForm) window.loginForm.reset();
            if (window.registerForm) window.registerForm.reset();
            
            // Clear session from IndexedDB
            if (sessionManager && window.currentUser) {
                sessionManager.clearSession(window.currentUser.uid)
                    .catch(error => console.error("Error clearing session:", error));
                sessionManager.clearPageState(window.currentUser.uid)
                    .catch(error => console.error("Error clearing page state:", error));
            }
        };

        window.onTodosChanged = async function() {
            await loadUserTodos();
        };

        // Expose functions to global scope for inline handlers
        // ‰ªÖË¶ÜÁõñÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÁöÑÂáΩÊï∞
        // Ê≥®ÊÑèÔºö‰ΩøÁî®‰πãÂâçÂÆö‰πâÁöÑÂáΩÊï∞ÔºåÂÆÉ‰ª¨Â∑≤ÁªèÂåÖÂê´‰∫ÜÂÆâÂÖ®Ê£ÄÊü•

        // ‰ªéfirebase-config.jsÂØºÂÖ•ÁöÑÂáΩÊï∞Â∑≤ÁªèÊ≠£Á°ÆÂ§ÑÁêÜÂèÇÊï∞ÔºåÊó†ÈúÄÈáçÊñ∞ÂÆö‰πâ
        // ‰øùÊåÅÂéüÊúâÁöÑÂáΩÊï∞ÂºïÁî®

        // ‰∏™‰∫∫‰ø°ÊÅØÁõ∏ÂÖ≥ÂáΩÊï∞
        function showProfileModal() {
            if (!window.currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }
            
            // Â°´ÂÖÖÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            document.getElementById('displayNameInput').value = window.currentUser.displayName || '';
            document.getElementById('emailInput').value = window.currentUser.email || '';
            
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function updateProfile() {
            if (!window.currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }
            
            const newDisplayName = document.getElementById('displayNameInput').value.trim();
            if (!newDisplayName) {
                alert('ÊòæÁ§∫ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }
            
            try {
                await window.currentUser.updateProfile({
                    displayName: newDisplayName
                });
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                if (window.userInfo) {
                    window.userInfo.textContent = `Ê¨¢Ëøé, ${newDisplayName}`;
                }
                
                alert('‰∏™‰∫∫‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                closeProfileModal();
            } catch (error) {
                console.error('Êõ¥Êñ∞‰∏™‰∫∫‰ø°ÊÅØÂ§±Ë¥•:', error);
                alert('Êõ¥Êñ∞‰∏™‰∫∫‰ø°ÊÅØÂ§±Ë¥•: ' + error.message);
            }
        }

        async function changePassword() {
            if (!window.currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword) {
                alert('ËØ∑ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å');
                return;
            }
            
            if (!newPassword) {
                alert('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                alert('Êñ∞ÂØÜÁ†Å‰∏éÁ°ÆËÆ§ÂØÜÁ†Å‰∏çÂåπÈÖç');
                return;
            }
            
            try {
                // ‰∏∫‰∫ÜÊõ¥ÊîπÂØÜÁ†ÅÔºåÊàë‰ª¨ÈúÄË¶ÅÈáçÊñ∞ËÆ§ËØÅÁî®Êà∑
                const credential = firebase.auth.EmailAuthProvider.credential(
                    window.currentUser.email,
                    currentPassword
                );
                
                // ÈáçÊñ∞È™åËØÅÁî®Êà∑
                await window.currentUser.reauthenticateWithCredential(credential);
                
                // Êõ¥Êñ∞ÂØÜÁ†Å
                await window.currentUser.updatePassword(newPassword);
                
                alert('ÂØÜÁ†Å‰øÆÊîπÊàêÂäüÔºÅ');
                
                // Ê∏ÖÁ©∫ÂØÜÁ†ÅÂ≠óÊÆµ
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
            } catch (error) {
                console.error('‰øÆÊîπÂØÜÁ†ÅÂ§±Ë¥•:', error);
                
                let errorMessage = '‰øÆÊîπÂØÜÁ†ÅÂ§±Ë¥•';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ÂΩìÂâçÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Â∞ùËØïÊ¨°Êï∞ËøáÂ§öÔºåËØ∑Á®çÂêéÂÜçËØï';
                } else {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // Selected todos tracking
        window.selectedTodos = new Set();

        // Select all todos
        function selectAllTodos() {
            const checkboxes = document.querySelectorAll('.todo-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const todoItem = checkbox.closest('.todo-item');
                todoItem.classList.add('selected');
                window.selectedTodos.add(todoItem.dataset.id);
            });
        }

        // Toggle todo selection
        function toggleTodoSelection(checkbox, todoId) {
            const todoItem = checkbox.closest('.todo-item');
            
            if (checkbox.checked) {
                todoItem.classList.add('selected');
                window.selectedTodos.add(todoId);
            } else {
                todoItem.classList.remove('selected');
                window.selectedTodos.delete(todoId);
            }
        }

        // Toggle completion for selected todos
        async function toggleSelectedCompletion() {
            if (window.selectedTodos.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊìç‰ΩúÁöÑ‰ªªÂä°');
                return;
            }

            for (const todoId of window.selectedTodos) {
                const todo = window.todos.find(t => t.id === todoId);
                if (todo) {
                    await toggleTodo(todoId);
                }
            }

            // Clear selection after operation
            clearSelection();
        }

        // Delete selected todos
        async function deleteSelectedTodos() {
            if (window.selectedTodos.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑ‰ªªÂä°');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${window.selectedTodos.size} ‰∏™‰ªªÂä°ÂêóÔºü`)) {
                return;
            }

            for (const todoId of window.selectedTodos) {
                await deleteTodo(todoId);
            }

            // Clear selection after operation
            clearSelection();
        }

        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            
            // Save preference to localStorage
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            
            // Update theme toggle button
            const themeBtn = document.querySelector('.theme-toggle-btn');
            themeBtn.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize theme based on saved preference or system preference
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            const useDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDark);
            
            if (useDarkMode) {
                document.body.classList.add('dark-mode');
            }
            
            // Update theme toggle button
            const themeBtn = document.querySelector('.theme-toggle-btn');
            if (themeBtn) {
                themeBtn.textContent = useDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Clear selection
        function clearSelection() {
            window.selectedTodos.clear();
            const todoItems = document.querySelectorAll('.todo-item');
            todoItems.forEach(item => {
                item.classList.remove('selected');
            });
            const checkboxes = document.querySelectorAll('.todo-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }

        // Initialize theme on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            
            // Initialize default tab
            switchTab('todo');
        });

        // Tab switching functionality
        async function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark corresponding nav item as active
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach((item, index) => {
                const spans = item.getElementsByTagName('span');
                if (spans.length > 0) {
                    const tabLabel = spans[0].textContent.trim();
                    if ((tabName === 'todo' && tabLabel === 'ÂæÖÂäû') ||
                        (tabName === 'today' && tabLabel === '‰ªäÂ§©') ||
                        (tabName === 'profile' && tabLabel === 'ÊàëÁöÑ')) {
                        item.classList.add('active');
                    }
                }
            });
            
            // If switching to profile tab, update profile info
            if (tabName === 'profile' && window.currentUser) {
                updateProfileInfo();
            }
            
            // Store the current page state in IndexedDB
            if (window.currentUser && sessionManager) {
                try {
                    await sessionManager.storePageState(window.currentUser.uid, tabName);
                    console.log("Current page state stored:", tabName);
                } catch (error) {
                    console.error("Error storing page state:", error);
                }
            }
        }

        // Update profile information in profile tab
        function updateProfileInfo() {
            if (window.currentUser) {
                document.getElementById('profileTabDisplayName').textContent = window.currentUser.displayName || window.currentUser.email;
                document.getElementById('profileTabEmail').textContent = window.currentUser.email || '';
                
                // Update achievement counters
                document.getElementById('profileTabTotalTasks').textContent = window.todos ? window.todos.length : 0;
                
                // Calculate consecutive days (simplified implementation)
                const consecutiveDays = Math.floor(Math.random() * 30) + 1; // Placeholder
                document.getElementById('profileTabConsecutiveDays').textContent = consecutiveDays;
            }
        }

        // Toggle sort menu
        function toggleSortMenu() {
            // In a real implementation, this would show a sort options menu
            alert('ÊéíÂ∫èÂäüËÉΩÂ∞ÜÂú®ÂêéÁª≠ÁâàÊú¨‰∏≠ÂÆûÁé∞');
        }

        // Focus mode functionality
        function toggleFocusMode() {
            alert('‰∏ìÊ≥®Ê®°ÂºèÂ∞ÜÂú®ÂêéÁª≠ÁâàÊú¨‰∏≠ÂÆûÁé∞');
        }

        // Magic feature (AI planning assistance)
        function triggerMagicFeature() {
            alert('AIËßÑÂàíÂä©ÊâãÂäüËÉΩÂ∞ÜÂú®ÂêéÁª≠ÁâàÊú¨‰∏≠ÂÆûÁé∞');
        }

        // Share achievements
        function shareAchievements() {
            if (navigator.share) {
                navigator.share({
                    title: 'ÊàëÁöÑTiimoÊàêÂ∞±',
                    text: 'ÊàëÂ∑≤ËøûÁª≠ËßÑÂàí‰∫ÜXÂ§©ÔºåÂÆåÊàê‰∫ÜY‰∏™‰ªªÂä°ÔºÅ',
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert('ÂàÜ‰∫´ÂäüËÉΩÈúÄË¶ÅÂú®HTTPSÁéØÂ¢É‰∏ã‰ΩøÁî®');
            }
        }

        // Export data functionality
        function exportData() {
            const data = {
                user: window.currentUser,
                todos: window.todos,
                createdAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'tiimo-data-export.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Save reflection entry
        function saveReflection() {
            const textarea = document.getElementById('profileTabReflectionTextarea');
            const content = textarea.value.trim();
            
            if (content) {
                alert('ÂèçÊÄùËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
                textarea.value = ''; // Clear after saving
            } else {
                alert('ËØ∑ËæìÂÖ•ÂèçÊÄùÂÜÖÂÆπ');
            }
        }

        // Function to detect mobile devices
        function isMobileDevice() {
            return window.innerWidth <= 768 || 
                   (navigator.userAgent.match(/Android/i) ||
                    navigator.userAgent.match(/webOS/i) ||
                    navigator.userAgent.match(/iPhone/i) ||
                    navigator.userAgent.match(/iPad/i) ||
                    navigator.userAgent.match(/iPod/i) ||
                    navigator.userAgent.match(/BlackBerry/i) ||
                    navigator.userAgent.match(/Windows Phone/i));
        }

        // Optimize layout for mobile when focusing on inputs
        function setupMobileInputOptimization() {
            if (!isMobileDevice()) return;

            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    // Add a class to adjust layout when input is focused
                    document.body.classList.add('input-focused');
                    
                    // For modals, scroll to the input field
                    const modal = this.closest('.modal-content');
                    if (modal) {
                        setTimeout(() => {
                            this.scrollIntoView({behavior: 'smooth', block: 'center'});
                        }, 300);
                    }
                });

                input.addEventListener('blur', function() {
                    // Remove class when input loses focus
                    document.body.classList.remove('input-focused');
                });
            });
        }

        // Run mobile optimization when page loads
        if (isMobileDevice()) {
            setupMobileInputOptimization();
        }

        // Close profile modal when clicking outside
        window.onclick = function(event) {
            const todoModal = document.getElementById('todoModal');
            const profileModal = document.getElementById('profileModal');
            
            if (event.target === todoModal) {
                closeModal();
            }
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
        };
    </script>
</body>
</html></body>
