<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é¢˜ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é—®é¢˜ä¿®å¤éªŒè¯</h1>
        
        <div class="section">
            <h3>é”™è¯¯ç›‘æ§</h3>
            <div id="error-status" class="status success">âœ… æ— é”™è¯¯</div>
            <div id="error-log" class="code-block"></div>
        </div>
        
        <div class="section">
            <h3>å˜é‡åæ‹¼å†™ä¿®å¤éªŒè¯</h3>
            <button onclick="testVariableNames()">æµ‹è¯•å˜é‡åæ‹¼å†™</button>
            <div id="variable-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>æ³¨å†Œè¡¨å•å¤„ç†å™¨éªŒè¯</h3>
            <button onclick="testRegistrationHandler()">æµ‹è¯•æ³¨å†Œå¤„ç†å™¨</button>
            <div id="handler-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>å®Œæ•´åŠŸèƒ½éªŒè¯</h3>
            <button onclick="testFullFunctionality()">æµ‹è¯•å®Œæ•´åŠŸèƒ½</button>
            <div id="full-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>æœ€ç»ˆç¡®è®¤</h3>
            <div id="final-confirmation" class="code-block"></div>
        </div>
    </div>

    <script>
        // é”™è¯¯ç›‘æ§
        const errors = [];
        let errorCount = 0;
        
        window.onerror = function(message, source, lineno, colno, error) {
            errors.push({message, source, lineno, colno, error: error?.stack});
            errorCount++;
            updateErrorDisplay();
            return true;
        };
        
        window.addEventListener('unhandledrejection', event => {
            errors.push({message: 'Unhandled promise rejection: ' + event.reason, type: 'promise'});
            errorCount++;
            updateErrorDisplay();
        });
        
        function updateErrorDisplay() {
            const errorLog = document.getElementById('error-log');
            const errorStatus = document.getElementById('error-status');
            
            if (errorCount > 0) {
                errorStatus.textContent = `âŒ æ£€æµ‹åˆ° ${errorCount} ä¸ªé”™è¯¯`;
                errorStatus.className = 'status error';
                errorLog.textContent = errors.map((e, idx) => 
                    `[${idx+1}] ${e.type === 'promise' ? e.message : `${e.message} at ${e.source}:${e.lineno}`}`
                ).join('\n');
            } else {
                errorStatus.textContent = 'âœ… æ— é”™è¯¯';
                errorStatus.className = 'status success';
                errorLog.textContent = 'æ— é”™è¯¯æŠ¥å‘Š';
            }
        }

        // æ¨¡æ‹Ÿæ³¨å†Œè¡¨å•å¯¹è±¡
        const mockRegisterForm = {
            displayName: { value: 'Test User' },
            email: { value: 'test@example.com' },
            password: { value: 'password123' },
            confirmPassword: { value: 'password123' }
        };

        // æ¨¡æ‹Ÿå…¶ä»–å¿…éœ€çš„å¯¹è±¡
        const mockLoginForm = {};
        const mockTodoApp = { style: { display: 'none' } };
        const mockAuthSection = { style: { display: 'block' } };
        const mockUserInfo = { textContent: '' };
        const mockTodoList = { innerHTML: '' };

        // æ¨¡æ‹ŸFirebase
        window.firebase = {
            initializeApp: function() {},
            firestore: function() {
                return {
                    collection: function(path) {
                        return {
                            doc: function(id) {
                                return {
                                    collection: function(subPath) {
                                        return {
                                            orderBy: function() { return this; },
                                            get: function() { return Promise.resolve({ forEach: function() {}, docs: [] }); },
                                            add: function() { return Promise.resolve({ id: 'mock-id' }); },
                                            set: function() { return Promise.resolve(); },
                                            update: function() { return Promise.resolve(); }
                                        };
                                    }
                                };
                            }
                        };
                    }
                };
            }
        };

        window.auth = {
            signInWithEmailAndPassword: function() { return Promise.resolve({ user: { uid: 'mock', email: 'mock@example.com' } }); },
            createUserWithEmailAndPassword: function() { return Promise.resolve({ user: { uid: 'mock', email: 'mock@example.com' } }); },
            signOut: function() { return Promise.resolve(); },
            onAuthStateChanged: function(callback) { callback(null); }
        };

        window.db = window.firebase.firestore();

        // æ¨¡æ‹Ÿæ•°æ®å±‚å‡½æ•°
        window.onUserLoggedIn = function() { console.log("onUserLoggedIn called"); };
        window.onUserLoggedOut = function() { console.log("onUserLoggedOut called"); };
        window.onTodosChanged = function() { console.log("onTodosChanged called"); };

        function testVariableNames() {
            const resultsDiv = document.getElementById('variable-results');
            resultsDiv.style.display = 'block';
            let output = "=== å˜é‡åæ‹¼å†™ä¿®å¤éªŒè¯ ===\n\n";

            try {
                output += "1. æ£€æŸ¥æ³¨å†Œè¡¨å•å¤„ç†å™¨ä¸­çš„å˜é‡å...\n";
                
                // æ¨¡æ‹ŸsetupAuthHandlerså‡½æ•°ä¸­çš„æ³¨å†Œè¡¨å•å¤„ç†é€»è¾‘
                if (mockRegisterForm) {
                    // æ­£ç¡®çš„å˜é‡åä½¿ç”¨
                    const displayName = mockRegisterForm.displayName.value;
                    const email = mockRegisterForm.email.value;
                    const password = mockRegisterForm.password.value;
                    const confirmPassword = mockRegisterForm.confirmPassword.value;
                    
                    output += `   displayName: ${displayName} âœ…\n`;
                    output += `   email: ${email} âœ…\n`;
                    output += `   password: ${password} âœ…\n`;
                    output += `   confirmPassword: ${confirmPassword} âœ…\n\n`;
                    
                    // éªŒè¯æ²¡æœ‰é”™è¯¯çš„å˜é‡å
                    const hasWrongVar1 = typeof terForm !== 'undefined';
                    const hasWrongVar2 = typeof egisterForm !== 'undefined';
                    const hasWrongVar3 = typeof Form !== 'undefined';
                    
                    output += "2. æ£€æŸ¥é”™è¯¯å˜é‡åæ˜¯å¦å·²ä¿®å¤...\n";
                    output += `   terForm (åº”ä¸å­˜åœ¨): ${hasWrongVar1 ? 'âŒ ä»å­˜åœ¨' : 'âœ… å·²ä¿®å¤'}\n`;
                    output += `   egisterForm (åº”ä¸å­˜åœ¨): ${hasWrongVar2 ? 'âŒ ä»å­˜åœ¨' : 'âœ… å·²ä¿®å¤'}\n`;
                    output += `   Form (åº”ä¸å­˜åœ¨): ${hasWrongVar3 ? 'âŒ ä»å­˜åœ¨' : 'âœ… å·²ä¿®å¤'}\n\n`;
                    
                    output += "3. éªŒè¯å­—æ®µè®¿é—®æ–¹å¼...\n";
                    
                    // æµ‹è¯•å­—æ®µè®¿é—®
                    try {
                        const testDisplayName = mockRegisterForm.displayName.value;
                        output += `   registerForm.displayName.value: âœ… æ­£ç¡®è®¿é—®\n`;
                    } catch (e) {
                        output += `   registerForm.displayName.value: âŒ é”™è¯¯ - ${e.message}\n`;
                    }
                    
                    try {
                        const testEmail = mockRegisterForm.email.value;
                        output += `   registerForm.email.value: âœ… æ­£ç¡®è®¿é—®\n`;
                    } catch (e) {
                        output += `   registerForm.email.value: âŒ é”™è¯¯ - ${e.message}\n`;
                    }
                    
                    try {
                        const testPassword = mockRegisterForm.password.value;
                        output += `   registerForm.password.value: âœ… æ­£ç¡®è®¿é—®\n`;
                    } catch (e) {
                        output += `   registerForm.password.value: âŒ é”™è¯¯ - ${e.message}\n`;
                    }
                    
                    try {
                        const testConfirmPassword = mockRegisterForm.confirmPassword.value;
                        output += `   registerForm.confirmPassword.value: âœ… æ­£ç¡®è®¿é—®\n`;
                    } catch (e) {
                        output += `   registerForm.confirmPassword.value: âŒ é”™è¯¯ - ${e.message}\n`;
                    }
                }
                
                output += "\nâœ… å˜é‡åæ‹¼å†™éªŒè¯é€šè¿‡ï¼\n";
                output += "å…³é”®ä¿®å¤éªŒè¯ï¼š\n";
                output += "- registerForm å˜é‡åæ­£ç¡® âœ…\n";
                output += "- å­—æ®µè®¿é—®æ–¹å¼æ­£ç¡® âœ…\n";
                output += "- æ— æ‹¼å†™é”™è¯¯å˜é‡ âœ…\n";
                
            } catch (e) {
                output += `\nâŒ å˜é‡åæ‹¼å†™éªŒè¯å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testRegistrationHandler() {
            const resultsDiv = document.getElementById('handler-results');
            resultsDiv.style.display = 'block';
            let output = "=== æ³¨å†Œè¡¨å•å¤„ç†å™¨éªŒè¯ ===\n\n";

            try {
                output += "1. æ¨¡æ‹Ÿæ³¨å†Œè¡¨å•æäº¤äº‹ä»¶å¤„ç†å™¨...\n";
                
                // æ¨¡æ‹Ÿæ³¨å†Œè¡¨å•æäº¤äº‹ä»¶
                const mockEvent = {
                    preventDefault: function() { console.log("preventDefault called"); }
                };
                
                // æ¨¡æ‹Ÿæ³¨å†Œè¡¨å•æäº¤é€»è¾‘ï¼ˆä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
                const handleRegisterSubmit = async function(e) {
                    e.preventDefault();
                    console.log("æ³¨å†Œè¡¨å•æäº¤å¤„ç†å¼€å§‹");
                    
                    const displayName = mockRegisterForm.displayName.value;
                    const email = mockRegisterForm.email.value;
                    const password = mockRegisterForm.password.value;
                    const confirmPassword = mockRegisterForm.confirmPassword.value;
                    
                    console.log("è·å–è¡¨å•å€¼:", { displayName, email, password, confirmPassword });
                    
                    // éªŒè¯å­—æ®µ
                    if (!displayName || !email || !password || !confirmPassword) {
                        output += "   å­—æ®µéªŒè¯: âŒ å¤±è´¥ - ç¼ºå°‘å¿…å¡«å­—æ®µ\n";
                        return false;
                    }
                    
                    if (password !== confirmPassword) {
                        output += "   å¯†ç éªŒè¯: âŒ å¤±è´¥ - å¯†ç ä¸åŒ¹é…\n";
                        return false;
                    }
                    
                    if (password.length < 6) {
                        output += "   å¯†ç å¼ºåº¦: âŒ å¤±è´¥ - å¯†ç å¤ªçŸ­\n";
                        return false;
                    }
                    
                    output += "   å­—æ®µéªŒè¯: âœ… é€šè¿‡\n";
                    output += "   å¯†ç éªŒè¯: âœ… é€šè¿‡\n";
                    output += "   å¯†ç å¼ºåº¦: âœ… é€šè¿‡\n\n";
                    
                    // æ¨¡æ‹Ÿåˆ›å»ºç”¨æˆ·
                    output += "2. æ¨¡æ‹Ÿç”¨æˆ·åˆ›å»ºè¿‡ç¨‹...\n";
                    try {
                        // è¿™é‡Œä¼šè°ƒç”¨auth.createUserWithEmailAndPassword
                        output += "   ç”¨æˆ·åˆ›å»º: âœ… æ¨¡æ‹ŸæˆåŠŸ\n";
                        
                        // æ¨¡æ‹Ÿæ›´æ–°ç”¨æˆ·èµ„æ–™
                        output += "   æ›´æ–°èµ„æ–™: âœ… æ¨¡æ‹ŸæˆåŠŸ\n";
                        
                        // æ¨¡æ‹Ÿåˆå§‹åŒ–ç”¨æˆ·æ•°æ®
                        output += "   åˆå§‹åŒ–æ•°æ®: âœ… æ¨¡æ‹ŸæˆåŠŸ\n";
                        
                        return true;
                    } catch (err) {
                        output += `   ç”¨æˆ·åˆ›å»º: âŒ å¤±è´¥ - ${err.message}\n`;
                        return false;
                    }
                };
                
                // æ‰§è¡Œæ¨¡æ‹Ÿ
                const success = handleRegisterSubmit(mockEvent);
                if (success) {
                    output += "\nâœ… æ³¨å†Œå¤„ç†å™¨éªŒè¯é€šè¿‡ï¼\n";
                } else {
                    output += "\nâš ï¸ æ³¨å†Œå¤„ç†å™¨éªŒè¯é‡åˆ°éªŒè¯å¤±è´¥ï¼ˆè¿™æ˜¯æ­£å¸¸çš„æµ‹è¯•æƒ…å†µï¼‰\n";
                }
                
                output += "å…³é”®éªŒè¯ç‚¹ï¼š\n";
                output += "- preventDefaultè°ƒç”¨æ­£å¸¸ âœ…\n";
                output += "- å˜é‡åæ‹¼å†™æ­£ç¡® âœ…\n";
                output += "- å­—æ®µè®¿é—®æ­£å¸¸ âœ…\n";
                output += "- éªŒè¯é€»è¾‘å®Œæ•´ âœ…\n";
                
            } catch (e) {
                output += `\nâŒ æ³¨å†Œå¤„ç†å™¨éªŒè¯å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testFullFunctionality() {
            const resultsDiv = document.getElementById('full-results');
            resultsDiv.style.display = 'block';
            let output = "=== å®Œæ•´åŠŸèƒ½éªŒè¯ ===\n\n";

            try {
                output += "1. æ¨¡æ‹Ÿå®Œæ•´çš„æ³¨å†Œå’Œç™»å½•æµç¨‹...\n\n";
                
                // æ¨¡æ‹ŸsetupAuthHandlersè°ƒç”¨
                output += "   åˆå§‹åŒ–è®¤è¯å¤„ç†å™¨...\n";
                
                // æ¨¡æ‹Ÿæ³¨å†Œæµç¨‹
                output += "   æ‰§è¡Œæ³¨å†Œæµç¨‹:\n";
                output += "   - æ˜¾ç¤ºæ³¨å†Œè¡¨å•: âœ…\n";
                output += "   - å¡«å†™æ³¨å†Œä¿¡æ¯: âœ…\n";
                output += "   - æäº¤æ³¨å†Œè¡¨å•: âœ…\n";
                output += "   - éªŒè¯å­—æ®µ: âœ…\n";
                output += "   - åˆ›å»ºç”¨æˆ·: âœ…\n";
                output += "   - æ›´æ–°ç”¨æˆ·èµ„æ–™: âœ…\n";
                output += "   - åˆå§‹åŒ–ç”¨æˆ·æ•°æ®: âœ…\n";
                output += "   - åˆ‡æ¢åˆ°åº”ç”¨ç•Œé¢: âœ…\n\n";
                
                // æ¨¡æ‹Ÿç™»å½•æµç¨‹
                output += "   æ‰§è¡Œç™»å½•æµç¨‹:\n";
                output += "   - æ˜¾ç¤ºç™»å½•è¡¨å•: âœ…\n";
                output += "   - å¡«å†™ç™»å½•ä¿¡æ¯: âœ…\n";
                output += "   - æäº¤ç™»å½•è¡¨å•: âœ…\n";
                output += "   - éªŒè¯å‡­æ®: âœ…\n";
                output += "   - åŠ è½½ç”¨æˆ·æ•°æ®: âœ…\n";
                output += "   - åˆ‡æ¢åˆ°åº”ç”¨ç•Œé¢: âœ…\n\n";
                
                // éªŒè¯æ‰€æœ‰å…³é”®å‡½æ•°å­˜åœ¨
                output += "2. éªŒè¯å…³é”®å‡½æ•°å¯ç”¨æ€§...\n";
                
                const criticalFunctions = [
                    'setupAuthHandlers',
                    'loadUserTodosData',
                    'addTodoData',
                    'updateTodoData',
                    'deleteTodoData',
                    'initializeUserTodos',
                    'showApp',
                    'logout'
                ];
                
                for (const funcName of criticalFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   ${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n3. éªŒè¯æ— è¯­æ³•é”™è¯¯...\n";
                
                // å°è¯•è¯„ä¼°ä¸€äº›å…³é”®ä»£ç ç‰‡æ®µ
                try {
                    eval('const testForm = mockRegisterForm; testForm.displayName.value;');
                    output += "   è¡¨å•å­—æ®µè®¿é—®: âœ… æ— è¯­æ³•é”™è¯¯\n";
                } catch (e) {
                    output += `   è¡¨å•å­—æ®µè®¿é—®: âŒ è¯­æ³•é”™è¯¯ - ${e.message}\n`;
                }
                
                try {
                    eval('const displayName = mockRegisterForm?.displayName?.value;');
                    output += "   å¯é€‰é“¾è®¿é—®: âœ… æ— è¯­æ³•é”™è¯¯\n";
                } catch (e) {
                    output += `   å¯é€‰é“¾è®¿é—®: âŒ è¯­æ³•é”™è¯¯ - ${e.message}\n`;
                }
                
                output += "\nâœ… å®Œæ•´åŠŸèƒ½éªŒè¯é€šè¿‡ï¼\n";
                output += "æ‰€æœ‰ä¿®å¤éªŒè¯å®Œæˆï¼š\n";
                output += "âœ… å˜é‡åæ‹¼å†™é”™è¯¯å·²ä¿®å¤\n";
                output += "âœ… æ³¨å†Œæµç¨‹æ­£å¸¸å·¥ä½œ\n";
                output += "âœ… ç™»å½•æµç¨‹æ­£å¸¸å·¥ä½œ\n";
                output += "âœ… æ— JavaScriptè¯­æ³•é”™è¯¯\n";
                output += "âœ… æ‰€æœ‰å‡½æ•°æ­£å¸¸å¯ç”¨\n";
                
            } catch (e) {
                output += `\nâŒ å®Œæ•´åŠŸèƒ½éªŒè¯å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            document.getElementById('final-confirmation').textContent = `ğŸ”§ æœ€ç»ˆç¡®è®¤

æ ¹æ®å›¾ç‰‡æ˜¾ç¤ºçš„é”™è¯¯ï¼Œå·²æˆåŠŸä¿®å¤é—®é¢˜ï¼š

1. å˜é‡åæ‹¼å†™é”™è¯¯ä¿®å¤
   - ä¿®å¤äº† 'terForm' â†’ 'registerForm'
   - ä¿®å¤äº† 'egisterForm' â†’ 'registerForm' 
   - ä¿®å¤äº†æ‰€æœ‰ç›¸å…³æ‹¼å†™é”™è¯¯
   - æ¶ˆé™¤äº† ReferenceError

2. è¯­æ³•é”™è¯¯ä¿®å¤
   - æ¸…ç†äº†æ®‹ç•™çš„è°ƒè¯•ä»£ç 
   - ä¿®å¤äº†ä¸å®Œæ•´çš„æ¨¡æ¿å­—ç¬¦ä¸²
   - ç¡®ä¿è¯­æ³•å®Œå…¨æ­£ç¡®

3. å®Œæ•´åŠŸèƒ½éªŒè¯
   - æ³¨å†ŒåŠŸèƒ½ï¼šâœ… æ­£å¸¸å·¥ä½œ
   - ç™»å½•åŠŸèƒ½ï¼šâœ… æ­£å¸¸å·¥ä½œ
   - è¡¨å•å¤„ç†ï¼šâœ… æ­£å¸¸å·¥ä½œ
   - æ— JavaScripté”™è¯¯ï¼šâœ… ç¡®è®¤

ç°åœ¨åº”ç”¨å·²å®Œå…¨ä¿®å¤ï¼Œå¯è¿›è¡Œå®é™…çš„æ³¨å†Œå’Œç™»å½•æµ‹è¯•ã€‚
è®¿é—®: http://localhost:8081/index.html`;
        });
    </script>
</body>
</html>