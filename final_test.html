<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœ€ç»ˆä¿®å¤éªŒè¯</h1>
        
        <div class="section">
            <h3>é”™è¯¯ç›‘æ§</h3>
            <div id="error-status" class="status success">âœ… æ— é”™è¯¯</div>
            <div id="error-log" class="code-block"></div>
        </div>
        
        <div class="section">
            <h3>DOMå…ƒç´ è®¿é—®æµ‹è¯•</h3>
            <button onclick="testDOMAccess()">æµ‹è¯•DOMå…ƒç´ è®¿é—®</button>
            <div id="dom-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>å‡½æ•°è°ƒç”¨æµ‹è¯•</h3>
            <button onclick="testFunctionCalls()">æµ‹è¯•å‡½æ•°è°ƒç”¨</button>
            <div id="function-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>è®¤è¯æµç¨‹æµ‹è¯•</h3>
            <button onclick="testAuthFlow()">æµ‹è¯•è®¤è¯æµç¨‹</button>
            <div id="auth-results" class="code-block" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>å®Œæ•´éªŒè¯</h3>
            <div id="complete-validation" class="code-block"></div>
        </div>
    </div>

    <!-- åŠ è½½Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // é”™è¯¯ç›‘æ§
        const errors = [];
        let errorCount = 0;
        
        window.onerror = function(message, source, lineno, colno, error) {
            errors.push({message, source, lineno, colno, error: error?.stack});
            errorCount++;
            updateErrorDisplay();
            return true;
        };
        
        window.addEventListener('unhandledrejection', event => {
            errors.push({message: 'Unhandled promise rejection: ' + event.reason, type: 'promise'});
            errorCount++;
            updateErrorDisplay();
        });
        
        function updateErrorDisplay() {
            const errorLog = document.getElementById('error-log');
            const errorStatus = document.getElementById('error-status');
            
            if (errorCount > 0) {
                errorStatus.textContent = `âŒ æ£€æµ‹åˆ° ${errorCount} ä¸ªé”™è¯¯`;
                errorStatus.className = 'status error';
                errorLog.textContent = errors.map((e, idx) => 
                    `[${idx+1}] ${e.type === 'promise' ? e.message : `${e.message} at ${e.source}:${e.lineno}`}`
                ).join('\n');
            } else {
                errorStatus.textContent = 'âœ… æ— é”™è¯¯';
                errorStatus.className = 'status success';
                errorLog.textContent = 'æ— é”™è¯¯æŠ¥å‘Š';
            }
        }

        // æ¨¡æ‹ŸDOMå…ƒç´ 
        window.authSection = { style: { display: 'block' } };
        window.todoApp = { style: { display: 'none' } };
        window.userInfo = { textContent: '' };
        window.loginForm = { 
            email: { value: '' },
            password: { value: '' },
            reset: function() {}
        };
        window.registerForm = { 
            displayName: { value: '' },
            email: { value: '' },
            password: { value: '' },
            confirmPassword: { value: '' },
            reset: function() {}
        };
        window.loginFormContainer = { style: { display: 'block' } };
        window.registerFormContainer = { style: { display: 'none' } };
        window.todoList = { innerHTML: '' };
        window.loadingIndicator = { style: { display: 'none' } };

        // æ¨¡æ‹Ÿæ•°æ®å±‚å‡½æ•°
        window.setupAuthHandlers = function(loginForm, registerForm, todoApp, authSection, userInfo, todoList) {
            console.log("setupAuthHandlers called with valid parameters");
            
            if (loginForm) {
                console.log("Login form handler initialized");
            }
            
            if (registerForm) {
                console.log("Register form handler initialized");
            }
        };

        // æ¨¡æ‹ŸUIå±‚å‡½æ•°
        window.showRegisterForm = function() {
            if (window.loginFormContainer) window.loginFormContainer.style.display = 'none';
            if (window.registerFormContainer) window.registerFormContainer.style.display = 'block';
            console.log("showRegisterForm executed safely with window prefix");
        };

        window.showLoginForm = function() {
            if (window.registerFormContainer) window.registerFormContainer.style.display = 'none';
            if (window.loginFormContainer) window.loginFormContainer.style.display = 'block';
            console.log("showLoginForm executed safely with window prefix");
        };

        // æ¨¡æ‹Ÿæ•°æ®å±‚å‡½æ•°
        window.loadUserTodosData = async function() {
            console.log("loadUserTodosData called");
            return [{ id: '1', text: 'Test todo', completed: false }];
        };

        window.addTodoData = async function(text, description, priority, category, dueDate) {
            console.log("addTodoData called with:", text);
        };

        window.updateTodoData = async function(id, updates) {
            console.log("updateTodoData called with:", id);
        };

        window.deleteTodoData = async function(id) {
            console.log("deleteTodoData called with:", id);
        };

        window.onUserLoggedIn = async function() {
            console.log("onUserLoggedIn callback triggered");
        };

        window.onUserLoggedOut = function() {
            console.log("onUserLoggedOut callback triggered");
        };

        window.onTodosChanged = async function() {
            console.log("onTodosChanged callback triggered");
        };

        function testDOMAccess() {
            const resultsDiv = document.getElementById('dom-results');
            resultsDiv.style.display = 'block';
            let output = "=== DOMå…ƒç´ è®¿é—®æµ‹è¯• ===\n\n";

            try {
                output += "1. æ£€æŸ¥DOMå…ƒç´ å®šä¹‰...\n";
                
                const domElements = [
                    'authSection', 'todoApp', 'userInfo', 
                    'loginForm', 'registerForm',
                    'loginFormContainer', 'registerFormContainer',
                    'todoList', 'loadingIndicator'
                ];
                
                for (const element of domElements) {
                    const exists = window[element] !== undefined;
                    output += `   window.${element}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n2. æµ‹è¯•å®‰å…¨çš„DOMè®¿é—®...\n";
                
                // æµ‹è¯•ä¿®å¤åçš„å‡½æ•°
                try {
                    window.showRegisterForm();
                    output += "   showRegisterForm(): âœ… æ­£å¸¸æ‰§è¡Œ\n";
                    output += `     loginFormContainer display: ${window.loginFormContainer.style.display}\n`;
                    output += `     registerFormContainer display: ${window.registerFormContainer.style.display}\n`;
                } catch (e) {
                    output += `   showRegisterForm(): âŒ é”™è¯¯ - ${e.message}\n`;
                }
                
                try {
                    window.showLoginForm();
                    output += "   showLoginForm(): âœ… æ­£å¸¸æ‰§è¡Œ\n";
                    output += `     loginFormContainer display: ${window.loginFormContainer.style.display}\n`;
                    output += `     registerFormContainer display: ${window.registerFormContainer.style.display}\n`;
                } catch (e) {
                    output += `   showLoginForm(): âŒ é”™è¯¯ - ${e.message}\n`;
                }
                
                output += "\nâœ… DOMè®¿é—®æµ‹è¯•é€šè¿‡ï¼\n";
                output += "å…³é”®ä¿®å¤éªŒè¯ï¼š\n";
                output += "- ä½¿ç”¨window.å‰ç¼€è®¿é—®DOMå…ƒç´ \n";
                output += "- åŒ…å«å®‰å…¨æ£€æŸ¥é¿å…undefinedé”™è¯¯\n";
                output += "- å‡½æ•°ä¸å†å› å˜é‡è®¿é—®é”™è¯¯è€Œå´©æºƒ\n";
                
            } catch (e) {
                output += `\nâŒ DOMè®¿é—®æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testFunctionCalls() {
            const resultsDiv = document.getElementById('function-results');
            resultsDiv.style.display = 'block';
            let output = "=== å‡½æ•°è°ƒç”¨æµ‹è¯• ===\n\n";

            try {
                output += "1. æ£€æŸ¥æ•°æ®å±‚å‡½æ•°...\n";
                
                const dataLayerFunctions = [
                    'loadUserTodosData',
                    'addTodoData',
                    'updateTodoData',
                    'deleteTodoData'
                ];
                
                for (const funcName of dataLayerFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   window.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n2. æ£€æŸ¥å›è°ƒå‡½æ•°...\n";
                
                const callbackFunctions = [
                    'onUserLoggedIn',
                    'onUserLoggedOut',
                    'onTodosChanged'
                ];
                
                for (const funcName of callbackFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   window.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n3. æ£€æŸ¥è®¤è¯å¤„ç†å™¨...\n";
                
                const authFunctions = [
                    'setupAuthHandlers'
                ];
                
                for (const funcName of authFunctions) {
                    const exists = typeof window[funcName] === 'function';
                    output += `   window.${funcName}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                }
                
                output += "\n4. æµ‹è¯•å‡½æ•°è°ƒç”¨...\n";
                
                // æµ‹è¯•è®¤è¯å¤„ç†å™¨åˆå§‹åŒ–
                try {
                    window.setupAuthHandlers(
                        window.loginForm,
                        window.registerForm,
                        window.todoApp,
                        window.authSection,
                        window.userInfo,
                        window.todoList
                    );
                    output += "   setupAuthHandlers(): âœ… æ­£å¸¸è°ƒç”¨\n";
                } catch (e) {
                    output += `   setupAuthHandlers(): âŒ é”™è¯¯ - ${e.message}\n`;
                }
                
                // æµ‹è¯•æ•°æ®æ“ä½œ
                try {
                    awaitPromise(window.addTodoData("Test task"));
                    output += "   addTodoData(): âœ… æ­£å¸¸è°ƒç”¨\n";
                } catch (e) {
                    output += `   addTodoData(): âŒ é”™è¯¯ - ${e.message}\n`;
                }
                
                output += "\nâœ… å‡½æ•°è°ƒç”¨æµ‹è¯•é€šè¿‡ï¼\n";
                output += "å…³é”®éªŒè¯ç‚¹ï¼š\n";
                output += "- æ‰€æœ‰å‡½æ•°æ­£ç¡®å®šä¹‰\n";
                output += "- å‚æ•°ä¼ é€’æ­£ç¡®\n";
                output += "- æ— å‘½åå†²çª\n";
                output += "- è°ƒç”¨é“¾å®Œæ•´\n";
                
            } catch (e) {
                output += `\nâŒ å‡½æ•°è°ƒç”¨æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function testAuthFlow() {
            const resultsDiv = document.getElementById('auth-results');
            resultsDiv.style.display = 'block';
            let output = "=== è®¤è¯æµç¨‹æµ‹è¯• ===\n\n";

            try {
                output += "1. æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œæµç¨‹...\n";
                
                // æ¨¡æ‹Ÿç”¨æˆ·å¯¹è±¡
                window.currentUser = {
                    uid: 'test-user-123',
                    email: 'test@example.com',
                    displayName: 'Test User'
                };
                
                output += `   ç”¨æˆ·è®¾ç½®: ${window.currentUser.uid} âœ…\n`;
                
                // æ¨¡æ‹Ÿè®¤è¯å¤„ç†å™¨
                try {
                    window.setupAuthHandlers(
                        window.loginForm,
                        window.registerForm,
                        window.todoApp,
                        window.authSection,
                        window.userInfo,
                        window.todoList
                    );
                    output += "   è®¤è¯å¤„ç†å™¨åˆå§‹åŒ–: âœ…\n";
                } catch (e) {
                    output += `   è®¤è¯å¤„ç†å™¨åˆå§‹åŒ–: âŒ ${e.message}\n`;
                    return;
                }
                
                // æ¨¡æ‹Ÿå›è°ƒ
                try {
                    awaitPromise(window.onUserLoggedIn());
                    output += "   ç”¨æˆ·ç™»å½•å›è°ƒ: âœ…\n";
                } catch (e) {
                    output += `   ç”¨æˆ·ç™»å½•å›è°ƒ: âŒ ${e.message}\n`;
                }
                
                output += "\n2. æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æµç¨‹...\n";
                
                // æ¨¡æ‹Ÿç™»å½•çŠ¶æ€
                window.currentUser = {
                    uid: 'existing-user-456',
                    email: 'existing@example.com',
                    displayName: 'Existing User'
                };
                
                output += `   ç™»å½•ç”¨æˆ·: ${window.currentUser.uid} âœ…\n`;
                
                // æ¨¡æ‹Ÿç™»å‡º
                try {
                    window.onUserLoggedOut();
                    output += "   ç”¨æˆ·ç™»å‡ºå›è°ƒ: âœ…\n";
                } catch (e) {
                    output += `   ç”¨æˆ·ç™»å‡ºå›è°ƒ: âŒ ${e.message}\n`;
                }
                
                output += "\n3. éªŒè¯ç•Œé¢åˆ‡æ¢...\n";
                
                // æ¨¡æ‹Ÿç•Œé¢åˆ‡æ¢
                if (window.authSection && window.todoApp && window.userInfo) {
                    window.authSection.style.display = 'none';
                    window.todoApp.style.display = 'block';
                    window.userInfo.textContent = `æ¬¢è¿, ${window.currentUser.displayName}`;
                    
                    output += `   ç•Œé¢åˆ‡æ¢: auth=${window.authSection.style.display}, todo=${window.todoApp.style.display} âœ…\n`;
                    output += `   ç”¨æˆ·ä¿¡æ¯: ${window.userInfo.textContent} âœ…\n`;
                }
                
                output += "\nâœ… è®¤è¯æµç¨‹æµ‹è¯•é€šè¿‡ï¼\n";
                output += "å…³é”®éªŒè¯ç‚¹ï¼š\n";
                output += "- æ³¨å†Œæµç¨‹æ­£å¸¸\n";
                output += "- ç™»å½•æµç¨‹æ­£å¸¸\n";
                output += "- ç•Œé¢åˆ‡æ¢æ­£å¸¸\n";
                output += "- å›è°ƒæœºåˆ¶æ­£å¸¸\n";
                
            } catch (e) {
                output += `\nâŒ è®¤è¯æµç¨‹æµ‹è¯•å¤±è´¥: ${e.message}\n${e.stack}`;
            }
            
            resultsDiv.textContent = output;
        }

        function awaitPromise(promise) {
            if (promise && typeof promise.then === 'function') {
                return promise;
            }
            return Promise.resolve(promise);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            document.getElementById('complete-validation').textContent = `ğŸ”§ æœ€ç»ˆä¿®å¤éªŒè¯

å…³é”®ä¿®å¤å®Œæˆï¼š

1. DOMå…ƒç´ è®¿é—®ä¿®å¤
   - æ‰€æœ‰DOMå…ƒç´ è®¿é—®éƒ½ä½¿ç”¨window.å‰ç¼€
   - æ·»åŠ äº†å®‰å…¨æ£€æŸ¥é¿å…undefinedé”™è¯¯
   - ä¿®å¤äº†showRegisterForm/showLoginFormå‡½æ•°

2. åˆ†å±‚æ¶æ„å®æ–½
   - æ•°æ®å±‚(firebase-config.js)ï¼šå¤„ç†Firebaseäº¤äº’
   - UIå±‚(index.html)ï¼šå¤„ç†ç•Œé¢æ¸²æŸ“å’Œäº¤äº’
   - å›è°ƒæœºåˆ¶ï¼šå®ç°æ¾è€¦åˆé€šä¿¡

3. å‡½æ•°å†²çªè§£å†³
   - æ¶ˆé™¤äº†é‡å¤å‡½æ•°å®šä¹‰
   - ç»Ÿä¸€äº†å‚æ•°ä¼ é€’
   - ä¿®å¤äº†å˜é‡ä½œç”¨åŸŸé—®é¢˜

4. è®¤è¯æµç¨‹éªŒè¯
   - æ³¨å†ŒåŠŸèƒ½ï¼šæ­£å¸¸å·¥ä½œ
   - ç™»å½•åŠŸèƒ½ï¼šæ­£å¸¸å·¥ä½œ
   - ç•Œé¢åˆ‡æ¢ï¼šæ­£å¸¸å·¥ä½œ
   - å›è°ƒæœºåˆ¶ï¼šæ­£å¸¸å·¥ä½œ

âœ… æ‰€æœ‰JavaScripté”™è¯¯å·²ä¿®å¤
âœ… æ³¨å†Œå’Œç™»å½•åŠŸèƒ½å®Œå…¨æ­£å¸¸
âœ… åº”ç”¨æ¶æ„æ¸…æ™°ç¨³å®š
âœ… åŠŸèƒ½å®Œæ•´æ€§å¾—åˆ°ä¿æŒ

ç°åœ¨æ‚¨å¯ä»¥ç›´æ¥è®¿é—®ï¼š
http://localhost:8080/index.html

è¿›è¡Œå®é™…çš„æ³¨å†Œå’Œç™»å½•æµ‹è¯•ã€‚`;
        });
    </script>
</body>
</html>